<!doctype html>
<!--
  Dashboard UI for local control.
  - Talks to the local Node server on /api/*.
  - Focuses on main functions, with detailed status in a separate tab.
  - Uses large controls for laptop screens and safe hold-to-toggle actions.
-->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#02030a" />
  <link rel="icon" type="image/svg+xml" href="/assets/dashboard-icon.svg" />
  <link rel="apple-touch-icon" href="/assets/dashboard-icon.svg" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <title>Dashboard - Sistema EvaluaPro</title>
  <style>
    :root {
      color-scheme: light;

      /* Motion (consistente y suave) */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.45, 0, 0.55, 1);
      --dur-xxs: 90ms;
      --dur-xs: 140ms;
      --dur-sm: 220ms;
      --dur-md: 320ms;
      --dur-ambient-1: 2200ms;
      --dur-ambient-2: 3200ms;
      --dur-ambient-3: 4200ms;
      --dur-hold: 120ms;

      /* Base */
      --bg: #f5f7fb;
      --panel: #ffffff;
      --surface: #f8fbff;
      --surface-2: #eef3f9;
      --surface-3: #f4f9ff;
      --surface-4: #fbfdff;
      --ink: #182232;
      --ink-soft: #4b6278;
      --border: #d5e2ef;
      --shadow: 0 10px 24px rgba(15, 23, 42, 0.10);

      /* Cyberpunk accents */
      --neon-cyan: #00d5ff;
      --neon-magenta: #ff2bd6;
      --neon-lime: #2dff8f;
      --neon-cyan-soft: rgba(0, 213, 255, 0.14);
      --neon-magenta-soft: rgba(255, 43, 214, 0.14);
      --neon-lime-soft: rgba(45, 255, 143, 0.14);

      /* UI accents */
      --accent: var(--neon-cyan);
      --accent-2: var(--neon-lime);
      --accent-3: var(--neon-magenta);
      --accent-soft: rgba(0, 213, 255, 0.12);

      /* Status */
      --warn: #fff2f1;
      --ok: #e9f7ef;

      /* Effects */
      --btn-hover: #d9e9ff;
      --grid-alpha: 0.06;
      --scan-alpha: 0.035;

      /* Header */
      --header-grad: linear-gradient(120deg, rgba(2, 6, 23, 0.94), rgba(0, 213, 255, 0.16) 55%, rgba(255, 43, 214, 0.22));
      --header-chip-bg: rgba(0, 0, 0, 0.24);
      --header-chip-border: rgba(255, 255, 255, 0.22);
    }

    :root[data-theme="dark"] {
      color-scheme: dark;

      /* AMOLED-ish base (menos azul, más profundo) */
      --bg: #02030a;
      --panel: rgba(8, 10, 14, 0.92);
      --surface: rgba(12, 14, 18, 0.78);
      --surface-2: rgba(16, 18, 22, 0.86);
      --surface-3: rgba(2, 3, 10, 0.72);
      --surface-4: rgba(10, 12, 16, 0.80);
      --ink: rgba(240, 244, 255, 0.96);
      --ink-soft: rgba(175, 186, 210, 0.92);
      --border: rgba(148, 163, 184, 0.18);
      --shadow: 0 22px 56px rgba(0, 0, 0, 0.58);

      /* Cyberpunk accents */
      --neon-cyan: #22e8ff;
      --neon-magenta: #ff38da;
      --neon-lime: #35ff93;
      --neon-cyan-soft: rgba(34, 232, 255, 0.14);
      --neon-magenta-soft: rgba(255, 56, 218, 0.14);
      --neon-lime-soft: rgba(53, 255, 147, 0.14);

      /* UI accents (menos azules) */
      --accent: var(--neon-cyan);
      --accent-2: var(--neon-lime);
      --accent-3: var(--neon-magenta);
      --accent-soft: rgba(34, 232, 255, 0.12);

      --warn: rgba(245, 158, 11, 0.14);
      --ok: rgba(34, 197, 94, 0.14);
      --btn-hover: rgba(34, 232, 255, 0.14);

      --grid-alpha: 0.07;
      --scan-alpha: 0.045;

      --header-grad: linear-gradient(120deg, rgba(2, 3, 10, 0.96), rgba(15, 23, 42, 0.70) 55%, rgba(255, 56, 218, 0.22));
      --header-chip-bg: rgba(2, 6, 23, 0.46);
      --header-chip-border: rgba(148, 163, 184, 0.22);
    }

    /* Estado del sistema (mood) -> afecta acentos y energía visual */
    :root[data-mood="ok"] {
      --accent: var(--neon-lime);
      --accent-3: var(--neon-cyan);
      --accent-soft: var(--neon-lime-soft);
    }
    :root[data-mood="warn"] {
      --accent: #f59e0b;
      --accent-3: var(--neon-magenta);
      --accent-soft: rgba(245, 158, 11, 0.14);
    }
    :root[data-mood="error"] {
      --accent: #ef4444;
      --accent-3: var(--neon-magenta);
      --accent-soft: rgba(239, 68, 68, 0.14);
    }
    :root[data-mood="info"] {
      --accent: var(--neon-cyan);
      --accent-3: var(--neon-magenta);
      --accent-soft: var(--neon-cyan-soft);
    }

    /* Hora del día (day/night/dawn/dusk) -> sutil, sin bajar legibilidad */
    :root[data-time="day"] { --grid-alpha: 0.055; --scan-alpha: 0.02; }
    :root[data-time="dawn"] { --grid-alpha: 0.06; --scan-alpha: 0.03; }
    :root[data-time="dusk"] { --grid-alpha: 0.07; --scan-alpha: 0.05; }
    :root[data-time="night"] { --grid-alpha: 0.075; --scan-alpha: 0.055; }

    :root[data-theme="light"][data-time="dusk"] {
      --header-grad: linear-gradient(120deg, rgba(2, 6, 23, 0.84), rgba(255, 43, 214, 0.22) 45%, rgba(0, 213, 255, 0.16));
    }
    :root[data-theme="dark"][data-time="night"] {
      --header-grad: linear-gradient(120deg, rgba(2, 3, 10, 0.98), rgba(34, 232, 255, 0.14) 55%, rgba(255, 56, 218, 0.20));
    }
    :root[data-theme="dark"][data-time="dawn"] {
      --header-grad: linear-gradient(120deg, rgba(2, 3, 10, 0.98), rgba(53, 255, 147, 0.10) 55%, rgba(34, 232, 255, 0.16));
    }

    * { box-sizing: border-box; }

    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 3px solid var(--neon-cyan);
      outline-offset: 3px;
      box-shadow: 0 0 0 4px rgba(0, 213, 255, 0.18);
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      font-size: clamp(14px, 0.95vw, 16px);
      background:
        radial-gradient(circle at 10% 12%, rgba(0, 213, 255, 0.10), transparent 42%),
        radial-gradient(circle at 90% 8%, rgba(255, 43, 214, 0.08), transparent 38%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 72%);
      color: var(--ink);
      min-height: 100vh;
      overflow-x: hidden;
    }

    :root[data-theme="dark"] body {
      background:
        radial-gradient(circle at 10% 12%, rgba(34, 232, 255, 0.12), transparent 44%),
        radial-gradient(circle at 90% 8%, rgba(255, 56, 218, 0.10), transparent 42%),
        radial-gradient(circle at 70% 88%, rgba(53, 255, 147, 0.06), transparent 46%),
        linear-gradient(180deg, #000000 0%, var(--bg) 100%);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.06), transparent 55%),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.08));
      opacity: 0.9;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255, 255, 255, var(--scan-alpha)) 0px,
          rgba(255, 255, 255, 0) 2px,
          rgba(255, 255, 255, 0) 6px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(255, 255, 255, var(--grid-alpha)) 0px,
          rgba(255, 255, 255, 0) 1px,
          rgba(255, 255, 255, 0) 22px
        );
      mix-blend-mode: overlay;
      opacity: 0.6;
    }

    header,
    main {
      position: relative;
      z-index: 1;
    }

    header {
      background: var(--header-grad);
      color: #ffffff;
      padding: calc(clamp(12px, 2vw, 18px) + env(safe-area-inset-top)) calc(clamp(12px, 2.5vw, 22px) + env(safe-area-inset-right)) clamp(12px, 2vw, 18px) calc(clamp(12px, 2.5vw, 22px) + env(safe-area-inset-left));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: clamp(8px, 1.5vw, 16px);
      position: sticky;
      top: 0;
      z-index: 3;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      width: 46px;
      height: 46px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      display: grid;
      place-items: center;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .logo:before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,0.26), transparent 60%);
      opacity: 0.85;
      animation: logoGlow var(--dur-ambient-2) var(--ease-in-out) infinite;
    }

    .logo:after {
      content: "";
      position: absolute;
      inset: -120% -120% -120% -120%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.22), transparent);
      transform: translateX(-30%) rotate(12deg);
      animation: logoSheen var(--dur-ambient-3) var(--ease-in-out) infinite;
      opacity: 0.75;
      pointer-events: none;
    }

    .logo svg {
      position: relative;
      width: 30px;
      height: 30px;
      overflow: visible;
    }

    .logo .stroke {
      fill: none;
      stroke: rgba(255,255,255,0.96);
      stroke-width: 1.9;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .logo .accent {
      fill: none;
      stroke: var(--neon-lime);
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 26 52;
      animation: circuitDash var(--dur-ambient-1) var(--ease-in-out) infinite;
    }

    .logo .node {
      fill: var(--neon-lime);
      opacity: 0.95;
      animation: nodePulse var(--dur-ambient-1) var(--ease-in-out) infinite;
    }

    .logo .node.n2 { animation-delay: 0.12s; }
    .logo .node.n3 { animation-delay: 0.24s; }
    .logo .node.n4 { animation-delay: 0.36s; }

    @keyframes logoGlow {
      0%,100% { transform: scale(1); opacity: 0.68; }
      50% { transform: scale(1.035); opacity: 0.92; }
    }

    @keyframes logoSheen {
      0% { transform: translateX(-35%) rotate(12deg); opacity: 0.0; }
      30% { opacity: 0.55; }
      55% { opacity: 0.25; }
      100% { transform: translateX(40%) rotate(12deg); opacity: 0.0; }
    }

    @keyframes circuitDash {
      0% { stroke-dashoffset: 0; opacity: 0.92; }
      50% { opacity: 1; }
      100% { stroke-dashoffset: -52; opacity: 0.92; }
    }

    @keyframes nodePulse {
      0%,100% { transform: scale(1); opacity: 0.86; }
      50% { transform: scale(1.11); opacity: 1; }
    }

    .title {
      font-size: clamp(14px, 2vw, 18px);
      font-weight: 700;
      letter-spacing: 0.3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subtitle {
      font-size: clamp(10px, 1.3vw, 12px);
      opacity: 0.96;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.28);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .header-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      background: rgba(0, 0, 0, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.22);
      color: #ffffff;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.28);
    }

    button.chip {
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.22);
    }

    button.chip:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    button.chip:active {
      transform: translateY(1px);
    }

    .chip.ok {
      background: var(--header-chip-bg);
      border: 1px solid var(--header-chip-border);
      border-color: rgba(34, 197, 94, 0.75);
    }

    .chip.warn {
      border-color: rgba(245, 158, 11, 0.75);
    }

    .chip.error {
      border-color: rgba(239, 68, 68, 0.75);
    }

    .sys-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 36px;
      height: 30px;
      padding: 0;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.22);
      color: #ffffff;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.16);
      transition: transform var(--dur-fast) var(--ease-out),
        background var(--dur-fast) var(--ease-out),
        border-color var(--dur-fast) var(--ease-out),
        box-shadow var(--dur-fast) var(--ease-out);
    }

    .sys-indicator svg {
      width: 16px;
      height: 16px;
      opacity: 0.95;
    }

    .sys-indicator:hover {
      transform: translateY(-1px);
      background: rgba(0, 0, 0, 0.3);
    }

    .sys-indicator:active {
      transform: translateY(0px);
    }

    :root[data-mood="ok"] .sys-indicator { border-color: rgba(34, 197, 94, 0.85); box-shadow: 0 14px 34px rgba(34, 197, 94, 0.14); }
    :root[data-mood="warn"] .sys-indicator { border-color: rgba(245, 158, 11, 0.9); box-shadow: 0 14px 34px rgba(245, 158, 11, 0.16); }
    :root[data-mood="error"] .sys-indicator { border-color: rgba(239, 68, 68, 0.9); box-shadow: 0 14px 34px rgba(239, 68, 68, 0.16); }
    :root[data-mood="info"] .sys-indicator { border-color: rgba(34, 232, 255, 0.85); box-shadow: 0 14px 34px rgba(34, 232, 255, 0.14); }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: var(--ink);
      word-break: break-all;
    }

    .install-grid {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .install-row {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 10px;
      align-items: start;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(0, 213, 255, 0.05), rgba(255, 43, 214, 0.03));
    }

    .install-row .k {
      color: var(--ink-soft);
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .install-row .v {
      color: var(--ink);
      font-weight: 700;
      font-size: 13px;
      line-height: 1.35;
    }

    main {
      padding: clamp(12px, 2vw, 22px) clamp(12px, 2.6vw, 28px) 30px;
      max-width: 3000px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin: 12px 0 18px;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 700;
      color: var(--ink-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform var(--dur-xs) var(--ease-out), box-shadow var(--dur-sm) var(--ease-out), background var(--dur-sm) var(--ease-out), border-color var(--dur-sm) var(--ease-out), color var(--dur-sm) var(--ease-out);
    }

    .tab-btn.active {
      color: #ffffff;
      background: linear-gradient(120deg, var(--accent), var(--neon-magenta));
      box-shadow:
        0 10px 22px rgba(0, 213, 255, 0.18),
        0 0 26px rgba(255, 43, 214, 0.14);
      transform: translateY(-1px);
    }

    .tab-btn.active .icon {
      fill: rgba(255, 255, 255, 0.96);
    }

    .tab-panel {
      display: none;
      animation: fadeUp var(--dur-md) var(--ease-out) both;
    }

    .tab-panel[hidden] { display: none; }

    .tab-panel.active { display: block; }

    .panel-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: clamp(12px, 1.4vw, 16px);
      align-items: start;
    }

    @media (min-width: 768px) {
      .panel-grid { grid-template-columns: minmax(240px, 320px) minmax(0, 1fr); }
    }

    @media (min-width: 1101px) {
      .panel-grid { grid-template-columns: minmax(280px, 380px) minmax(0, 1fr); }
    }

    @media (min-width: 1500px) {
      .panel-grid { grid-template-columns: minmax(320px, 420px) minmax(0, 1fr); }
    }

    .left-col {
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .right-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      grid-auto-flow: row dense;
      align-items: start;
    }

    .right-grid .card {
      grid-column: span 12;
      margin-top: 0;
    }

    .right-grid .card.wide { grid-column: 1 / -1; }

    .card.wide { grid-column: 1 / -1; }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: clamp(12px, 1.5vw, 18px);
      padding: clamp(12px, 1.4vw, 16px);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: fadeUp var(--dur-md) var(--ease-out) both;
      transition: transform var(--dur-xs) var(--ease-out), box-shadow var(--dur-sm) var(--ease-out), border-color var(--dur-sm) var(--ease-out), background var(--dur-sm) var(--ease-out);
      word-wrap: break-word;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow:
        0 20px 44px rgba(0, 0, 0, 0.10),
        0 0 0 1px rgba(0, 213, 255, 0.10),
        0 0 28px rgba(255, 43, 214, 0.08);
    }

    :root[data-theme="dark"] .card:hover {
      transform: translateY(-1px);
      box-shadow:
        0 26px 64px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(34, 232, 255, 0.18),
        0 0 36px rgba(255, 56, 218, 0.14);
    }

    .card::after {
      content: '';
      position: absolute;
      top: -40%;
      right: -30%;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, var(--neon-cyan-soft), transparent 70%);
      pointer-events: none;
    }

    .card + .card { margin-top: 0; }

    .alert-card { border-left: 4px solid #f59e0b; }
    .alert-card.ok { border-left-color: #22c55e; }
    .alert-card.error { border-left-color: #ef4444; }
    .alert-body { display: flex; gap: 16px; align-items: flex-start; }
    .alert-icon {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: rgba(245, 158, 11, 0.14);
      color: #b45309;
      font-weight: 800;
      font-size: 18px;
    }
    .alert-card.ok .alert-icon { background: rgba(34, 197, 94, 0.14); color: #166534; }
    .alert-card.error .alert-icon { background: rgba(239, 68, 68, 0.14); color: #b91c1c; }

    :root[data-theme="dark"] .alert-icon {
      background: rgba(245, 158, 11, 0.16);
      color: rgba(253, 230, 138, 0.96);
    }

    :root[data-theme="dark"] .alert-card.ok .alert-icon {
      background: rgba(34, 197, 94, 0.14);
      color: rgba(187, 247, 208, 0.96);
    }

    :root[data-theme="dark"] .alert-card.error .alert-icon {
      background: rgba(239, 68, 68, 0.14);
      color: rgba(254, 202, 202, 0.96);
    }
    .alert-content { flex: 1; min-width: 0; }
    .alert-content h3 { margin: 0; font-size: 15px; }
    .alert-content p { margin: 6px 0 0; color: var(--ink-soft); font-size: 13px; }
    .alert-meta {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--ink-soft);
    }
    .alert-actions { display: flex; gap: 8px; align-items: center; }
    button.ghost-btn {
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--ink);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      line-height: 1.2;
      transition: transform var(--dur-xxs) var(--ease-out), box-shadow var(--dur-xs) var(--ease-out), background var(--dur-xs) var(--ease-out), border-color var(--dur-xs) var(--ease-out), color var(--dur-xs) var(--ease-out);
    }
    button.ghost-btn:hover { box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12); }
    button.ghost-btn:active { transform: translateY(1px) scale(0.995); }

    button.ghost-btn.pending {
      opacity: 0.88;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.10);
      border-color: rgba(15, 23, 42, 0.12);
    }

    :root[data-theme="dark"] button.ghost-btn.pending {
      border-color: rgba(148, 163, 184, 0.22);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.26);
    }

    button.ghost-btn[data-hold-ms] {
      position: relative;
      overflow: hidden;
    }

    button.ghost-btn[data-hold-ms]::before {
      content: '';
      position: absolute;
      inset: -1px;
      background:
        radial-gradient(circle at 20% 50%, rgba(0, 213, 255, 0.18), transparent 55%),
        radial-gradient(circle at 80% 30%, rgba(255, 43, 214, 0.12), transparent 60%);
      opacity: 0;
      transition: opacity var(--dur-xs) var(--ease-out);
      pointer-events: none;
      z-index: 0;
    }

    button.ghost-btn.is-holding::before { opacity: 1; }

    button.ghost-btn > * {
      position: relative;
      z-index: 1;
    }

    button.ghost-btn[data-hold-ms]::after {
      content: '';
      position: absolute;
      inset: 0;
      width: calc(var(--hold, 0) * 1%);
      background: linear-gradient(90deg, rgba(0, 213, 255, 0.16), rgba(255, 43, 214, 0.06));
      z-index: 0;
      pointer-events: none;
      transition: width var(--dur-hold) linear;
    }

    button.ghost-btn.is-holding {
      box-shadow:
        0 12px 26px rgba(0, 213, 255, 0.14),
        0 0 24px rgba(255, 43, 214, 0.10);
    }

    button.ghost-btn.hold-btn {
      padding: 10px 14px;
      gap: 2px;
      flex-direction: column;
      border-radius: 16px;
      min-width: 0;
      width: auto;
    }

    button.ghost-btn.hold-btn .btn-row {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      row-gap: 4px;
    }

    button.ghost-btn.hold-btn .btn-text {
      white-space: normal;
      text-align: center;
    }

    button.ghost-btn.hold-btn .btn-sub {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink-soft);
      opacity: 0.95;
    }

    button.ghost-btn.restart-btn {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #7c2d12;
    }

    button.ghost-btn.restart-btn:hover {
      background: #ffedd5;
      border-color: #fdba74;
    }

    button.ghost-btn.restart-btn.is-holding {
      box-shadow: 0 12px 24px rgba(124, 45, 18, 0.18);
    }

    :root[data-theme="dark"] button.ghost-btn.restart-btn {
      background: rgba(245, 158, 11, 0.14);
      border-color: rgba(245, 158, 11, 0.32);
      color: rgba(253, 230, 138, 0.96);
    }

    :root[data-theme="dark"] button.ghost-btn.restart-btn:hover {
      background: rgba(245, 158, 11, 0.18);
      border-color: rgba(245, 158, 11, 0.38);
    }

    :root[data-theme="dark"] button.ghost-btn.restart-btn.is-holding {
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.28);
    }

    button.ghost-btn.hold-done {
      animation: holdDone var(--dur-md) var(--ease-out) both;
    }

    @keyframes holdDone {
      0% { transform: translateY(0) scale(1); }
      45% { transform: translateY(-1px) scale(1.015); }
      100% { transform: translateY(0) scale(1); }
    }

    .signal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(110px, 16vw, 140px), 1fr));
      gap: clamp(8px, 1.2vw, 12px);
      margin-bottom: clamp(8px, 1.2vw, 12px);
    }
    .signal-pill {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
      background: var(--surface);
    }
    .signal-pill span { font-size: 16px; color: var(--ink); }
    .signal-pill.error { background: #fff1f2; border-color: #fecdd3; color: #b91c1c; }
    .signal-pill.warn { background: #fff7ed; border-color: #fed7aa; color: #9a3412; }
    .signal-pill.ok { background: #ecfdf3; border-color: #bbf7d0; color: #166534; }
    .signal-pill.info { background: rgba(0, 213, 255, 0.08); border-color: rgba(0, 213, 255, 0.24); color: rgba(2, 67, 82, 0.92); }

    :root[data-theme="dark"] .signal-pill.error { background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.28); color: rgba(254, 202, 202, 0.95); }
    :root[data-theme="dark"] .signal-pill.warn { background: rgba(245, 158, 11, 0.14); border-color: rgba(245, 158, 11, 0.28); color: rgba(253, 230, 138, 0.95); }
    :root[data-theme="dark"] .signal-pill.ok { background: rgba(34, 197, 94, 0.12); border-color: rgba(34, 197, 94, 0.26); color: rgba(187, 247, 208, 0.95); }
    :root[data-theme="dark"] .signal-pill.info { background: rgba(34, 232, 255, 0.12); border-color: rgba(34, 232, 255, 0.28); color: rgba(165, 251, 255, 0.95); }

    .event-feed { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    .event-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }
    .event-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: 6px;
      background: #94a3b8;
      box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.2);
    }
    .event-item.error .event-dot { background: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2); }
    .event-item.warn .event-dot { background: #f59e0b; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2); }
    .event-item.ok .event-dot { background: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); }
    .event-item.info .event-dot { background: var(--neon-cyan); box-shadow: 0 0 0 4px rgba(0, 213, 255, 0.22); }
    .event-text { flex: 1; font-size: 13px; color: var(--ink); }
    .event-meta { margin-top: 4px; font-size: 12px; color: var(--ink-soft); display: flex; gap: 10px; flex-wrap: wrap; }
    .event-time { margin-left: auto; font-size: 12px; color: var(--ink-soft); }
    .event-empty { padding: 12px; border: 1px dashed var(--border); border-radius: 12px; color: var(--ink-soft); font-size: 12px; }

    @media (max-width: 900px) {
      .alert-body { flex-direction: column; }
      .alert-actions { width: 100%; justify-content: flex-start; }
    }

    .card h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 12px 0;
      color: var(--ink-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon {
      width: 16px;
      height: 16px;
      fill: var(--accent-2);
      display: inline-block;
      transform-origin: 50% 50%;
      transition: transform var(--dur-xs) var(--ease-out), filter var(--dur-sm) var(--ease-out), opacity var(--dur-sm) var(--ease-out);
    }

    button:hover .icon,
    a:hover .icon {
      transform: translateY(-1px) scale(1.06);
      filtro: drop-shadow(0 14px 26px rgba(0, 213, 255, 0.18));
    }

    button:active .icon,
    a:active .icon {
      transform: translateY(0) scale(0.98);
      filtro: none;
    }

    @keyframes iconSpin {
      from { transform: translateY(-1px) scale(1.06) rotate(0deg); }
      to { transform: translateY(-1px) scale(1.06) rotate(360deg); }
    }

    .restart-btn:hover .icon {
      animation: iconSpin var(--dur-md) var(--ease-out) 1;
    }

    .stack { display: grid; gap: 12px; }

    .entornos-actions {
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background:
        radial-gradient(circle at 10% 10%, rgba(0, 213, 255, 0.10), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(255, 43, 214, 0.07), transparent 60%),
        var(--surface-4);
      box-shadow: 0 10px 24px rgba(0, 213, 255, 0.08);
      display: grid;
      gap: 10px;
    }

    :root[data-theme="dark"] .entornos-actions {
      box-shadow: 0 16px 34px rgba(0, 0, 0, 0.26);
    }

    .entornos-actions-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .entornos-actions-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--ink-soft);
      font-weight: 800;
    }

    .entornos-actions-sub {
      font-size: 12px;
      color: var(--ink-soft);
    }

    .entornos-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      align-items: stretch;
    }

    .entornos-actions-grid .ghost-btn {
      width: 100%;
      max-width: none;
      min-width: 0;
    }

    @media (max-width: 380px) {
      .entornos-actions { padding: 10px; }
    }

    .card.card-entornos {
      overflow: visible;
    }

    .hint {
      font-size: 13px;
      color: var(--ink-soft);
      margin: 0 0 12px 0;
    }

    button {
      border: 1px solid var(--border);
      background: var(--accent-soft);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform var(--dur-xxs) var(--ease-out), background var(--dur-sm) var(--ease-out), box-shadow var(--dur-sm) var(--ease-out), border-color var(--dur-sm) var(--ease-out), color var(--dur-sm) var(--ease-out);
    }

    button:hover {
      background: var(--btn-hover);
      box-shadow:
        0 10px 22px rgba(0, 213, 255, 0.12),
        0 0 20px rgba(255, 43, 214, 0.08);
    }
    button:active { transform: translateY(1px); }

    button.danger { background: var(--warn); }
    button.ok { background: var(--ok); }

    .toggle-btn {
      position: relative;
      overflow: hidden;
      display: grid;
      grid-template-columns: clamp(20px, 3vw, 28px) minmax(0, 1fr) auto;
      align-items: center;
      gap: clamp(8px, 1.2vw, 12px);
      padding: 10px 12px;
      border-radius: 14px;
      min-height: clamp(54px, 7vw, 64px);
      background: var(--surface-3);
    }

    .toggle-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      width: calc(var(--hold, 0) * 1%);
      background: linear-gradient(90deg, rgba(0, 213, 255, 0.18), rgba(255, 43, 214, 0.06));
      pointer-events: none;
      transition: width var(--dur-hold) linear;
    }

    .toggle-btn.active { background: var(--surface-2); }
    .toggle-btn.pending { opacity: 0.85; }

    .toggle-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
      z-index: 1;
    }

    .toggle-title {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    .toggle-sub {
      font-size: 12.5px;
      color: var(--ink-soft);
      line-height: 1.2;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }

    .toggle-state {
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
      padding: 5px 9px;
      border-radius: 999px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      z-index: 1;
      white-space: nowrap;
      justify-self: end;
    }

    .toggle-btn.active .toggle-state {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .toggle-btn.pending .toggle-state {
      background: #fff6e6;
      color: #8a5800;
      border-color: #ffd9a8;
    }

    :root[data-theme="dark"] .toggle-btn.active .toggle-state {
      background: rgba(34, 197, 94, 0.14);
      color: rgba(187, 247, 208, 0.96);
      border-color: rgba(34, 197, 94, 0.32);
    }

    :root[data-theme="dark"] .toggle-btn.pending .toggle-state {
      background: rgba(245, 158, 11, 0.14);
      color: rgba(253, 230, 138, 0.96);
      border-color: rgba(245, 158, 11, 0.32);
    }

    .status-dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: #94a3b8;
      border: 1px solid rgba(15, 23, 42, 0.12);
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.10);
      z-index: 1;
    }

    .toggle-btn.active .status-dot {
      background: #22c55e;
      border-color: rgba(34, 197, 94, 0.35);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.14);
      animation: pulse var(--dur-ambient-2) var(--ease-in-out) infinite;
    }

    .links {
      display: grid;
      gap: 12px;
    }

    .link-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    :root[data-theme="dark"] .link-item {
      box-shadow: inset 0 0 0 1px rgba(2, 6, 23, 0.55);
    }

    .link-item.inactive {
      border-style: dashed;
      opacity: 0.6;
    }

    .link-item a {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--ink);
      font-weight: 700;
    }

    .link-item .icon {
      fill: var(--accent-2);
    }

    .link-copy {
      display: grid;
      gap: 2px;
    }

    .link-title {
      font-size: 15px;
      color: var(--ink);
    }

    .link-meta {
      font-size: 13px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .link-chip {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--ink-soft);
    }

    :root[data-theme="dark"] .link-chip.dev {
      background: rgba(34, 232, 255, 0.12);
      color: rgba(165, 251, 255, 0.96);
      border-color: rgba(34, 232, 255, 0.30);
    }

    :root[data-theme="dark"] .link-chip.prod {
      background: rgba(34, 197, 94, 0.14);
      color: rgba(187, 247, 208, 0.96);
      border-color: rgba(34, 197, 94, 0.32);
    }

    :root[data-theme="dark"] .link-chip.api {
      background: rgba(245, 158, 11, 0.14);
      color: rgba(253, 230, 138, 0.96);
      border-color: rgba(245, 158, 11, 0.32);
    }

    .link-chip.dev {
      background: rgba(0, 213, 255, 0.10);
      color: rgba(2, 67, 82, 0.92);
      border-color: rgba(0, 213, 255, 0.26);
    }

    .link-chip.prod {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .link-chip.api {
      background: #fff3e6;
      color: #8a5800;
      border-color: #ffd9a8;
    }

    .link-note {
      margin-left: 32px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }

    .link-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 32px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }

    .health-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .health-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .health-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .health-text {
      font-weight: 700;
      color: var(--ink);
    }

    .health-latency {
      margin-left: auto;
      font-weight: 600;
      color: var(--ink-soft);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 18vw, 180px), 1fr));
      gap: clamp(8px, 1.2vw, 12px);
    }

    .metric {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 6px;
      min-height: 78px;
      position: relative;
      overflow: hidden;
    }

    .metric::after {
      content: '';
      position: absolute;
      inset: auto -20% -45% -20%;
      height: 70%;
      background: linear-gradient(120deg, rgba(0, 213, 255, 0.12), transparent 70%);
    }

    .metric .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .metric .value {
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 20vw, 200px), 1fr));
      gap: clamp(8px, 1.2vw, 12px);
      margin-bottom: clamp(8px, 1.2vw, 12px);
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(0, 213, 255, 0.10), #ffffff);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      gap: 6px;
    }

    :root[data-theme="dark"] .summary-card {
      background: linear-gradient(135deg, rgba(34, 232, 255, 0.12), rgba(15, 23, 42, 0.92));
    }

    .summary-card .label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--ink-soft);
      letter-spacing: 0.6px;
    }

    .summary-card .value {
      font-size: 20px;
      font-weight: 700;
    }

    .analytics-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .chart-block {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .chart-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .chart-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .health-block {
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(0, 213, 255, 0.08), rgba(255, 255, 255, 0) 60%), var(--surface-4);
    }

    :root[data-theme="dark"] .health-block {
      background: linear-gradient(135deg, rgba(34, 232, 255, 0.12), rgba(8, 10, 14, 0.86));
    }

    .health-stats {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .health-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      background: var(--surface);
      color: var(--ink-soft);
    }

    .health-chip.ok {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }

    .health-chip.down {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #9a3412;
    }

    .health-chip.time {
      background: var(--surface-2);
      color: var(--ink-soft);
    }

    :root[data-theme="dark"] .health-chip.ok {
      background: rgba(34, 197, 94, 0.14);
      border-color: rgba(34, 197, 94, 0.32);
      color: rgba(187, 247, 208, 0.96);
    }

    :root[data-theme="dark"] .health-chip.down {
      background: rgba(245, 158, 11, 0.14);
      border-color: rgba(245, 158, 11, 0.32);
      color: rgba(253, 230, 138, 0.96);
    }

    :root[data-theme="dark"] .health-chip.time {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.22);
      color: rgba(226, 232, 240, 0.88);
    }

    .mini-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 94px;
      padding: 10px 12px 8px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0, 213, 255, 0.08), transparent 60%), var(--surface);
      position: relative;
      overflow: hidden;
    }

    .mini-chart::before {
      content: '';
      position: absolute;
      inset: 10px;
      background: repeating-linear-gradient(
        0deg,
        rgba(148, 163, 184, 0.18) 0px,
        rgba(148, 163, 184, 0.18) 1px,
        transparent 1px,
        transparent 18px
      );
      opacity: 0.6;
      pointer-events: none;
    }

    :root[data-theme="dark"] .mini-chart::before {
      background: repeating-linear-gradient(
        0deg,
        rgba(148, 163, 184, 0.22) 0px,
        rgba(148, 163, 184, 0.22) 1px,
        transparent 1px,
        transparent 18px
      );
      opacity: 0.4;
    }

    .mini-chart-wrap {
      display: grid;
      grid-template-columns: 36px 1fr;
      align-items: end;
      gap: 10px;
    }

    .mini-axis {
      height: 94px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-soft);
    }

    .mini-bar {
      width: 12px;
      border-radius: 8px;
      background: linear-gradient(180deg, #22c55e 0%, #4ade80 100%);
      opacity: 0.95;
      position: relative;
      z-index: 1;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.18), 0 8px 18px rgba(34, 197, 94, 0.18);
      animation: barRise var(--dur-xs) var(--ease-out) both;
      transform-origin: bottom;
    }

    .mini-bar.down {
      background: linear-gradient(180deg, #f59e0b 0%, #f97316 100%);
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.22), 0 8px 18px rgba(245, 158, 11, 0.18);
      opacity: 0.85;
    }

    .mini-bar::after {
      content: '';
      position: absolute;
      left: 2px;
      right: 2px;
      top: 2px;
      height: 3px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.65);
      opacity: 0.4;
    }

    .mini-bar.latest {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 213, 255, 0.18), 0 10px 22px rgba(0, 213, 255, 0.18);
    }

    @keyframes barRise {
      from { transform: scaleY(0.25); opacity: 0.35; }
      to { transform: scaleY(1); opacity: 0.95; }
    }

    @media (max-width: 520px) {
      .mini-chart-wrap {
        grid-template-columns: 1fr;
      }

      .mini-axis {
        display: none;
      }
    }

    .activity-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .activity-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .activity-dot.warn {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    .activity-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .activity-text {
      font-weight: 600;
      color: var(--ink);
    }

    .activity-time {
      margin-left: auto;
      font-size: 13px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .activity-empty {
      font-size: 12px;
      color: var(--ink-soft);
      padding: 12px;
      text-align: center;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: var(--surface);
    }

    .chart-empty {
      font-size: 12px;
      color: var(--ink-soft);
      padding: 10px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      width: 100%;
      text-align: center;
      background: var(--surface);
    }

    .service-list {
      display: grid;
      gap: 10px;
    }

    .service-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .service-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .service-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .service-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .service-copy {
      display: grid;
      gap: 2px;
    }

    .service-title {
      font-weight: 700;
      font-size: 13px;
    }

    .service-meta {
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .service-badge {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--ink-soft);
    }

    :root[data-theme="dark"] .service-badge.ok {
      background: rgba(34, 197, 94, 0.14);
      color: rgba(187, 247, 208, 0.96);
      border-color: rgba(34, 197, 94, 0.32);
    }

    :root[data-theme="dark"] .service-badge.down {
      background: rgba(239, 68, 68, 0.12);
      color: rgba(254, 202, 202, 0.96);
      border-color: rgba(239, 68, 68, 0.32);
    }

    .service-badge.ok {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .service-badge.down {
      background: #fff1f2;
      color: #9f1239;
      border-color: #fecdd3;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .legend.health-legend {
      gap: 10px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .legend-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .legend-dot.down {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    .health-hint {
      margin-top: 8px;
    }

    .health-last-event {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: var(--surface);
      font-weight: 600;
    }

    :root[data-theme="dark"] .health-last-event {
      background: rgba(8, 10, 14, 0.6);
    }
    .quote {
      background: linear-gradient(135deg, rgba(0, 213, 255, 0.10), #ffffff);
      border: 1px solid rgba(0, 213, 255, 0.22);
      border-radius: 16px;
      padding: 16px 18px;
      display: grid;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    :root[data-theme="dark"] .quote {
      background: linear-gradient(135deg, rgba(34, 232, 255, 0.10), rgba(15, 23, 42, 0.92));
      border-color: rgba(148, 163, 184, 0.22);
    }

    .quote-tag {
      align-self: start;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--accent);
      background: var(--accent-soft);
      border: 1px solid rgba(0, 213, 255, 0.26);
      padding: 4px 10px;
      border-radius: 999px;
    }

    .quote-text {
      margin: 0;
      font-size: 16px;
      line-height: 1.5;
      color: var(--ink);
      font-weight: 600;
    }

    .quote-author {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .status-grid {
      display: grid;
      gap: 8px;
      font-size: 14px;
      color: var(--ink-soft);
    }

    .status-grid span {
      color: var(--ink);
      font-weight: 700;
    }

    .log-shell {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #0f172a;
      color: #e2e8f0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .log-shell.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0;
      border: none;
    }

    .log-body {
      padding: clamp(10px, 1.5vw, 14px);
      height: clamp(280px, 46vh, 720px);
      overflow: auto;
      font-family: Consolas, monospace;
      font-size: clamp(10px, 1.2vw, 12px);
      word-break: break-word;
    }

    .eventos-estado {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--panel);
      padding: 12px;
      margin: 10px 0 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    :root[data-theme="dark"] .eventos-estado {
      box-shadow: inset 0 0 0 1px rgba(2, 6, 23, 0.55);
    }

    .eventos-estado-cabecera {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .eventos-estado-titulo {
      font-weight: 900;
      color: var(--ink);
      font-size: 13px;
    }

    .eventos-estado-subtitulo {
      font-size: 12px;
      color: var(--ink-soft);
      margin-bottom: 10px;
    }

    .eventos-estado-lista {
      display: grid;
      gap: 8px;
    }

    .evento-estado {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px 12px 16px;
      background: var(--surface);
      display: grid;
      gap: 8px;
      position: relative;
      overflow: hidden;
      --event-accent: rgba(148, 163, 184, 0.7);
    }

    .evento-estado::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 10px;
      bottom: 10px;
      width: 3px;
      border-radius: 999px;
      background: var(--event-accent);
      opacity: 0.9;
    }

    .evento-estado .encabezado {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .evento-estado .hora {
      font-weight: 900;
      color: var(--ink);
      font-size: 12px;
    }

    .evento-estado .pildora-nivel {
      font-size: 10px;
      font-weight: 900;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .evento-estado .pildora-nivel.ok {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.32);
      color: #166534;
    }

    .evento-estado .pildora-nivel.warn {
      background: rgba(245, 158, 11, 0.18);
      border-color: rgba(245, 158, 11, 0.32);
      color: #9a3412;
    }

    .evento-estado .pildora-nivel.error {
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.32);
      color: #b91c1c;
    }

    :root[data-theme="dark"] .evento-estado .pildora-nivel.ok {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.36);
      color: rgba(187, 247, 208, 0.95);
    }

    :root[data-theme="dark"] .evento-estado .pildora-nivel.warn {
      background: rgba(245, 158, 11, 0.2);
      border-color: rgba(245, 158, 11, 0.36);
      color: rgba(253, 230, 138, 0.96);
    }

    :root[data-theme="dark"] .evento-estado .pildora-nivel.error {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.36);
      color: rgba(254, 202, 202, 0.96);
    }

    .evento-estado .etiqueta {
      font-size: 11px;
      font-weight: 900;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--ink-soft);
      letter-spacing: 0.02em;
    }

    .evento-estado .etiqueta.codigo {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      text-transform: none;
    }

    .evento-estado.error { border-color: rgba(239, 68, 68, 0.28); background: rgba(254, 226, 226, 0.40); }
    .evento-estado.warn { border-color: rgba(245, 158, 11, 0.28); background: rgba(255, 237, 213, 0.45); }
    .evento-estado.ok { border-color: rgba(34, 197, 94, 0.26); background: rgba(220, 252, 231, 0.45); }

    :root[data-theme="dark"] .evento-estado.error { border-color: rgba(239, 68, 68, 0.28); background: rgba(239, 68, 68, 0.12); }
    :root[data-theme="dark"] .evento-estado.warn { border-color: rgba(245, 158, 11, 0.28); background: rgba(245, 158, 11, 0.14); }
    :root[data-theme="dark"] .evento-estado.ok { border-color: rgba(34, 197, 94, 0.26); background: rgba(34, 197, 94, 0.12); }

    .evento-estado.error { --event-accent: rgba(239, 68, 68, 0.8); }
    .evento-estado.warn { --event-accent: rgba(245, 158, 11, 0.85); }
    .evento-estado.ok { --event-accent: rgba(34, 197, 94, 0.8); }

    .evento-estado .mensaje {
      display: grid;
      gap: 4px;
    }

    .evento-estado .mensaje-titulo {
      font-size: 12px;
      color: var(--ink);
      font-weight: 700;
    }

    .evento-estado .mensaje-subtitulo {
      font-size: 11px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .evento-estado .mensaje-meta {
      font-size: 10.5px;
      color: var(--ink-soft);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      opacity: 0.9;
    }

    .evento-estado .detalles {
      display: none;
      gap: 6px;
      border-top: 1px dashed var(--border);
      padding-top: 8px;
    }

    .evento-estado .detalles-titulo {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-soft);
    }

    .evento-estado .detalles-cuerpo {
      margin: 0;
      font-size: 11px;
      color: var(--ink-soft);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--surface-2);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
    }

    .evento-estado.con-detalles { cursor: pointer; }
    .evento-estado.con-detalles:hover { box-shadow: 0 12px 20px rgba(15, 23, 42, 0.08); }
    .evento-estado.abierto .detalles { display: grid; }

    .log-line {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(226, 232, 240, 0.12);
      animation: fadeIn 0.2s ease both;
    }

    .log-line.has-meta { cursor: pointer; }
    .log-line.has-meta:hover { background: rgba(255, 255, 255, 0.04); }
    .log-line.open { background: rgba(255, 255, 255, 0.03); }

    .log-line .meta { color: #94a3b8; margin-right: 6px; }
    .log-line .meta-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 6px;
      opacity: 0.9;
    }

    .log-line .pill {
      border: 1px solid rgba(226, 232, 240, 0.22);
      background: rgba(15, 23, 42, 0.16);
      color: #e2e8f0;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }

    .log-line .meta-json {
      margin-top: 6px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #cbd5e1;
      opacity: 0.95;
      display: none;
    }

    .log-line.open .meta-json { display: block; }
    .log-line.error { color: #fecaca; }
    .log-line.warn { color: #fde68a; }
    .log-line.ok { color: #bbf7d0; }
    .log-line.system { color: #bae6fd; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .toolbar-grid {
      display: grid;
      gap: 10px;
      align-items: center;
      grid-template-columns: 1fr;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .toolbar-group.actions button {
      flex: 1 1 160px;
    }

    .toolbar-group.switches {
      row-gap: 8px;
    }

    .toolbar-group.filter {
      width: 100%;
    }

    .toolbar-group.filter .search {
      flex: 999 1 260px;
      min-width: 160px;
    }

    .toolbar-group.filter button {
      flex: 0 0 auto;
    }

    @media (min-width: 720px) {
      .toolbar-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .toolbar-group.actions button {
        flex: 0 0 auto;
      }
    }

    @media (min-width: 1101px) {
      .toolbar-grid {
        grid-template-columns: auto minmax(320px, 1fr) minmax(360px, 520px);
        column-gap: 12px;
      }
      .toolbar-group.filter {
        justify-content: flex-end;
      }
    }

    @media (min-width: 1500px) {
      .toolbar-grid {
        grid-template-columns: auto minmax(420px, 1fr) minmax(520px, 720px);
      }
    }

    .toolbar.top-space {
      margin-top: 12px;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .toggle input { accent-color: var(--accent-2); }

    .search {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      min-width: 180px;
      flex: 999 1 320px;
      background: var(--panel);
      color: var(--ink);
    }

    .search::placeholder {
      color: var(--ink-soft);
      opacity: 0.75;
    }

    .pills { display: flex; gap: 10px; flex-wrap: wrap; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
    }

    .dot.active {
      background: #22c55e;
      animation: pulse var(--dur-ambient-2) var(--ease-in-out) infinite;
    }

    .toast-wrap {
      position: fixed;
      top: calc(86px + env(safe-area-inset-top));
      right: 18px;
      display: grid;
      gap: 10px;
      z-index: 10;
    }

    .toast {
      background: var(--panel);
      color: var(--ink);
      border-radius: 12px;
      padding: 12px 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      min-width: 260px;
      max-width: min(440px, calc(100vw - 40px));
      display: grid;
      grid-template-columns: 34px 1fr auto;
      gap: 10px;
      align-items: start;
      animation: toastIn var(--dur-sm) var(--ease-out) both;
      position: relative;
      overflow: hidden;
    }

    .toast::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 3px;
      transform-origin: left;
      transform: scaleX(1);
      background: linear-gradient(90deg, rgba(0, 213, 255, 0.26), rgba(255, 43, 214, 0.22));
      animation: toastLife var(--toast-duration, 2600ms) linear forwards;
    }

    .toast.pausado::after { animation-play-state: paused; }

    .toast.out { animation: toastOut var(--dur-xs) var(--ease-out) forwards; }

    .toast-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 900;
      font-size: 14px;
      -webkit-user-select: none;
      user-select: none;
    }

    .toast-body { min-width: 0; }
    .toast-title { margin: 0; font-size: 12px; font-weight: 900; letter-spacing: 0.01em; }
    .toast-text { margin: 3px 0 0; font-size: 13px; color: var(--ink-soft); }
    .toast-actions { display: inline-flex; gap: 8px; align-items: center; }

    .toast-btn {
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--ink);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      transition: transform var(--dur-xxs) var(--ease-out), box-shadow var(--dur-xs) var(--ease-out), background var(--dur-xs) var(--ease-out), border-color var(--dur-xs) var(--ease-out);
    }

    :root[data-theme="dark"] .toast-btn.action {
      border-color: rgba(34, 232, 255, 0.30);
      background: rgba(34, 232, 255, 0.12);
    }

    :root[data-theme="dark"] .toast.ok .toast-icon { color: rgba(187, 247, 208, 0.96); }
    :root[data-theme="dark"] .toast.warn .toast-icon { color: rgba(253, 230, 138, 0.96); }
    :root[data-theme="dark"] .toast.error .toast-icon { color: rgba(254, 202, 202, 0.96); }
    :root[data-theme="dark"] .toast.info .toast-icon { color: var(--neon-cyan); }

    .toast-btn:hover { box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12); }
    .toast-btn:active { transform: translateY(1px); }

    .toast-btn.action { border-color: rgba(0, 213, 255, 0.28); background: rgba(0, 213, 255, 0.10); }
    .toast-btn.close { padding: 6px 8px; }

    .toast.ok { border-left: 4px solid #22c55e; }
    .toast.warn { border-left: 4px solid #f59e0b; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.info { border-left: 4px solid var(--neon-cyan); }

    .toast.ok .toast-icon { background: rgba(34, 197, 94, 0.14); color: #166534; }
    .toast.warn .toast-icon { background: rgba(245, 158, 11, 0.14); color: #9a3412; }
    .toast.error .toast-icon { background: rgba(239, 68, 68, 0.14); color: #b91c1c; }
    .toast.info .toast-icon { background: rgba(0, 213, 255, 0.14); color: rgba(2, 67, 82, 0.92); }

    :root[data-theme="dark"] .toast.info .toast-icon { background: rgba(34, 232, 255, 0.14); }

    @keyframes fadeUp {
      from { transform: translateY(8px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.18); opacity: 0.78; }
    }

    @keyframes toastIn {
      from { transform: translateY(-6px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes toastOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-6px); opacity: 0; }
    }

    @keyframes toastLife {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      .toast,
      .toast::after,
      button.ghost-btn.hold-done,
      .dot.active {
        animation: none !important;
        transition: none !important;
      }
    }

    @media (max-width: 767px) {
      .header-chips { width: 100%; }
      .toast-wrap { right: 10px; left: 10px; top: 72px; }
      .toast { min-width: auto; max-width: 100%; }
    }

    @media (max-width: 1100px) {
      .panel-grid { grid-template-columns: 1fr; }
      .right-grid { grid-template-columns: 1fr; }
      .right-grid .card { grid-column: 1 / -1; }
    }

    @media (min-width: 1101px) and (max-width: 1199px) {
      .right-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .right-grid .card { grid-column: auto; }
      .right-grid .card.wide { grid-column: 1 / -1; }
    }

    @media (min-width: 1200px) {
      .right-grid {
        grid-template-areas:
          "stack stack stack stack stack stack stack stack stack stack stack stack"
          "analytics analytics analytics analytics analytics analytics activity activity activity activity activity activity"
          "links links links links links links links links links links links links";
      }

      .stack-card { grid-area: stack; }
      .analytics-card { grid-area: analytics; }
      .activity-card { grid-area: activity; }
      .links-card { grid-area: links; }

      .analytics-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .summary-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .metrics { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .links { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .service-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (min-width: 1500px) {
      .links { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    #panel-status .panel-grid {
      grid-template-columns: minmax(0, 1fr);
    }

    @media (min-width: 1101px) {
      #panel-status .panel-grid { grid-template-columns: minmax(320px, 420px) minmax(0, 1fr); }
    }

    @media (min-width: 1500px) {
      #panel-status .panel-grid { grid-template-columns: minmax(360px, 520px) minmax(0, 1fr); }
    }

    @media (max-width: 900px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-chips {
        width: 100%;
        justify-content: flex-start;
      }

      .tabs {
        gap: 8px;
      }

      .tab-btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 700px) {
      main { padding: 12px; }
      .card { padding: 14px; }
      .toggle-btn { height: auto; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    @media (prefers-contrast: more) {
      .subtitle { opacity: 1; }
      .chip {
        background: rgba(0, 0, 0, 0.42);
        border-color: rgba(255, 255, 255, 0.35);
      }
      .chip.ok { border-color: rgba(34, 197, 94, 0.95); }
      .chip.warn { border-color: rgba(245, 158, 11, 0.95); }
      .chip.error { border-color: rgba(239, 68, 68, 0.95); }

      .toolbar-spaced { margin-top: 12px; }
      .toolbar-right { justify-content: flex-end; }

      .db-embed-wrap {
        margin-top: 12px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        overflow: hidden;
        background: rgba(2, 6, 23, 0.6);
      }
      .db-iframe {
        width: 100%;
        height: 680px;
        border: 0;
        display: block;
      }
      .hint-spaced { margin-top: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
          <!-- Birrete -->
          <path class="stroke" d="M16 4l12 5.2-12 5.2L4 9.2 16 4z" />
          <path class="stroke" d="M10 13v3c0 2 2.7 3.8 6 3.8s6-1.8 6-3.8v-3" />
          <path class="stroke" d="M28 9.2v6.8" />
          <circle class="stroke" cx="28" cy="17.6" r="1.2" />

          <!-- Pizarra -->
          <path class="stroke" d="M7 16.5h18a3 3 0 0 1 3 3V26a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-6.5a3 3 0 0 1 3-3z" />
          <path class="stroke" d="M9.5 20.5h7" opacity="0.85" />
          <path class="stroke" d="M9.5 23.8h5" opacity="0.75" />

          <!-- Circuito -->
          <path class="accent" d="M10 25.6h5v-2.8h4v2.8h5" />
          <circle class="node n1" cx="10" cy="25.6" r="1.4" />
          <circle class="node n2" cx="15" cy="25.6" r="1.4" />
          <circle class="node n3" cx="19" cy="22.8" r="1.4" />
          <circle class="node n4" cx="24" cy="25.6" r="1.4" />
        </svg>
      </div>
      <div>
        <div class="title">Dashboard - Sistema EvaluaPro</div>
        <div class="subtitle">Control local del stack, tareas y salud de servicios</div>
      </div>
    </div>
    <div class="header-chips">
      <span class="chip" id="version-chip">Version: -</span>
      <span class="chip" id="ui-chip">UI: -</span>
      <span class="chip" id="port-chip">Puerto: -</span>
      <span class="chip" id="mode-chip">Modo: -</span>
      <span class="chip" id="running-chip">Procesos: -</span>
      <span class="chip" id="pausado-chip">Actualización: Activa</span>
      <span class="chip" id="connection-chip">Conexión: -</span>
      <button class="sys-indicator" id="system-indicator" type="button" title="Estado del sistema" aria-label="Estado del sistema">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 2l7 3v6c0 5-3 9-7 11C8 20 5 16 5 11V5l7-3z" fill="none" stroke="currentColor" stroke-width="1.8" />
          <path d="M12 7v6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
          <circle cx="12" cy="16.8" r="1" fill="currentColor" />
        </svg>
      </button>
      <button class="chip" id="theme-toggle" type="button" title="Cambiar tema (claro/oscuro)">Tema</button>
    </div>
  </header>

  <div class="toast-wrap" id="toast-wrap" role="status" aria-live="polite" aria-atomic="true"></div>

  <main>
    <div class="tabs" role="tablist" aria-label="Secciones del dashboard">
      <button
        id="tab-main"
        class="tab-btn active"
        data-tab="main"
        role="tab"
        aria-selected="true"
        aria-controls="panel-main"
        tabindex="0"
      >
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 4h7v7H4V4zm9 0h7v7h-7V4zM4 13h7v7H4v-7zm9 0h7v7h-7v-7z"/></svg>
        Principal
      </button>
      <button
        id="tab-status"
        class="tab-btn"
        data-tab="status"
        role="tab"
        aria-selected="false"
        aria-controls="panel-status"
        tabindex="-1"
      >
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 19h16v2H4v-2zM6 4h4v11H6V4zm6 3h4v8h-4V7z"/></svg>
        Estado y logs
      </button>
      <button
        id="tab-db"
        class="tab-btn"
        data-tab="db"
        role="tab"
        aria-selected="false"
        aria-controls="panel-db"
        tabindex="-1"
      >
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C7.6 2 4 3.8 4 6v12c0 2.2 3.6 4 8 4s8-1.8 8-4V6c0-2.2-3.6-4-8-4zm0 2c3.9 0 6 .9 6 2s-2.1 2-6 2-6-.9-6-2 2.1-2 6-2zm0 16c-3.9 0-6-.9-6-2v-2c1.5 1.1 4.1 1.7 6 1.7s4.5-.6 6-1.7v2c0 1.1-2.1 2-6 2zm0-6c-3.9 0-6-.9-6-2V9.9C7.5 11 10.1 11.6 12 11.6s4.5-.6 6-1.7V12c0 1.1-2.1 2-6 2z"/></svg>
        Base de datos
      </button>
    </div>

    <section id="panel-main" class="tab-panel active" data-panel="main" role="tabpanel" tabindex="0" aria-labelledby="tab-main">
      <div class="panel-grid">
        <div class="left-col">
          <div class="card card-entornos">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M8 5v14l11-7L8 5z"/>
              </svg>
              Entornos
            </h2>
            <p class="hint" id="hint-hold">Mantener presionado 1.2s para iniciar/detener o reiniciar (evita clics accidentales).</p>
            <div class="stack">
              <button class="toggle-btn" data-env="dev" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Dev local (Docker + Web)</span>
                  <span class="toggle-sub" data-sub>Mantener 1.2s para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
              <button class="toggle-btn" data-env="prod" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Prod local (Docker API)</span>
                  <span class="toggle-sub" data-sub>Mantener 1.2s para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
              <button class="toggle-btn" data-env="portal" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Portal alumno (API)</span>
                  <span class="toggle-sub" data-sub>Mantener 1.2s para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
            </div>

            <div class="entornos-actions" aria-label="Reinicios">
              <div class="entornos-actions-head">
                <div class="entornos-actions-title">Reinicios globales</div>
                <div class="entornos-actions-sub">Acciones seguras con mantener 1.2s</div>
              </div>
              <div class="entornos-actions-grid">
                <button class="ghost-btn hold-btn restart-btn" data-restart="stack" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia los servicios activos">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3-6.7V3h-6v6h6V6.4A7 7 0 1 0 19 12h2Z"/></svg>
                    <span class="btn-text">Reiniciar stack</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
                <button class="ghost-btn hold-btn restart-btn" data-restart="all" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia todos los procesos activos">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6V3L8 7l4 4V8c2.8 0 5 2.2 5 5a5 5 0 0 1-9.7 1.6l-1.8.8A7 7 0 1 0 12 6Z"/></svg>
                    <span class="btn-text">Reiniciar todo</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
              </div>
            </div>
          </div>


        </div>

        <div class="right-grid">
          <div class="card wide stack-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v16H4V4zm2 2v4h12V6H6zm0 6v6h12v-6H6z"/>
              </svg>
              Estado del stack
            </h2>
            <div class="summary-grid">
              <div class="summary-card">
                <div class="label">Modo actual</div>
                <div class="value" id="mode">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Entornos activos</div>
                <div class="value" id="running-count">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Procesos activos</div>
                <div class="value" id="running">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Última actualización</div>
                <div class="value" id="last-refresh">-</div>
              </div>
            </div>
            <div class="status-grid">
              <div>Docker: <span id="docker-state-main">-</span></div>
              <div>Stack Docker: <span id="stack-state-main">-</span></div>
              <div>Proyecto: <span id="root">-</span></div>
            </div>
          </div>

          <div class="card wide alert-card ok" id="alert-card">
            <div class="alert-body">
              <div class="alert-icon" id="alert-icon">OK</div>
              <div class="alert-content">
                <h3 id="alert-title">Sin alertas activas</h3>
                <p id="alert-message">No hay errores recientes en los servicios monitoreados.</p>
                <div class="alert-meta">
                  <span id="alert-source">Origen: -</span>
                  <span id="alert-time">Hora: -</span>
                </div>
              </div>
              <div class="alert-actions">
                <button class="ghost-btn" id="alert-open-logs" type="button">Abrir logs</button>
              </div>
            </div>
          </div>

          <div class="card analytics-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16v2H4v-2zM5 5h4v11H5V5zm7 3h4v8h-4V8z"/>
              </svg>
              Analitica rapida
            </h2>
            <p class="hint">Salud y actividad recientes (ventana de 15 min).</p>
            <div class="summary-grid analytics-grid">
              <div class="summary-card">
                <div class="label">Servicios activos</div>
                <div class="value" id="health-ok">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Servicios caidos</div>
                <div class="value" id="health-down">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Eventos recientes (inicio/detención)</div>
                <div class="value" id="recent-events">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Tiempo de sesion</div>
                <div class="value" id="session-mins">-</div>
              </div>
            </div>
            <p class="hint">Tiempo de sesion = minutos desde que abriste este dashboard en tu navegador.</p>
            <div class="chart-block">
              <div class="chart-title">Servicios monitorizados</div>
              <div class="service-list" id="service-list">
                <div class="service-item" id="service-web-docente">
                  <span class="service-dot" id="service-web-docente-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">Web docente</div>
                    <div class="service-meta">UI local (5173/4173)</div>
                  </div>
                  <span class="service-badge" id="service-web-docente-badge">Sin comprobar</span>
                </div>
                <div class="service-item" id="service-api-docente">
                  <span class="service-dot" id="service-api-docente-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">API docente</div>
                    <div class="service-meta">Backend local (4000)</div>
                  </div>
                  <span class="service-badge" id="service-api-docente-badge">Sin comprobar</span>
                </div>
                <div class="service-item" id="service-api-portal">
                  <span class="service-dot" id="service-api-portal-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">API portal alumno</div>
                    <div class="service-meta">Portal alumno (8080)</div>
                  </div>
                  <span class="service-badge" id="service-api-portal-badge">Sin comprobar</span>
                </div>
              </div>
            </div>
            <div class="chart-block health-block">
              <div class="chart-title-row">
                <div class="chart-title">Salud reciente (ultimos ciclos)</div>
                <div class="health-stats">
                  <span class="health-chip ok" id="health-last-ok">OK -</span>
                  <span class="health-chip down" id="health-last-down">Caidas -</span>
                  <span class="health-chip time" id="health-last-time">Ultimo: --</span>
                </div>
              </div>
              <div class="mini-chart-wrap">
                <div class="mini-axis">
                  <span>100%</span>
                  <span>50%</span>
                  <span>0%</span>
                </div>
                <div class="mini-chart" id="health-history"></div>
              </div>
              <div class="legend health-legend">
                <span class="legend-item"><span class="legend-dot ok"></span>OK</span>
                <span class="legend-item"><span class="legend-dot down"></span>Caida detectada</span>
              </div>
              <div class="hint health-hint">Cada barra representa un ciclo (~3s). Altura = % de servicios OK. Naranja = hubo caida.</div>
              <div class="hint health-last-event" id="last-event">Sin actividad reciente.</div>
            </div>
          </div>

          <div class="card activity-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 8a4 4 0 100 8 4 4 0 000-8zm0-6a10 10 0 11-7.1 2.9A10 10 0 0112 2zm0 2a8 8 0 100 16 8 8 0 000-16z"/>
              </svg>
              Actividad reciente
            </h2>
            <p class="hint">Registra inicios y detenciones de entornos (dev, prod, portal) detectados por el dashboard.</p>
            <ul class="activity-list" id="activity-list">
              <li class="activity-empty">Sin actividad reciente.</li>
            </ul>
          </div>

          <div class="card wide links-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M10 6h8v8h-2V9.4l-9.3 9.3-1.4-1.4L14.6 8H10V6z"/>
              </svg>
              Accesos y salud
            </h2>
            <p class="hint">El acceso a la Web Docente se ajusta al modo activo. Dev usa Vite (5173) y prod usa serve (4173).</p>
            <div class="links">
              <div class="link-item" id="web-docente-item">
                <a id="web-docente-link" href="http://localhost:5173" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18v14H3V5zm2 2v10h14V7H5z"/></svg>
                  <div class="link-copy">
                    <div class="link-title">Web docente</div>
                    <div class="link-meta" id="web-docente-meta">Dev local (Vite) - 5173</div>
                  </div>
                  <span class="link-chip dev" id="web-docente-chip">DEV</span>
                </a>
                <div class="link-note" id="web-docente-note">Se ajusta al modo activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-web-docente-dot"></span>
                  <span class="health-text" id="health-web-docente-text">Sin comprobar</span>
                  <span class="health-latency" id="health-web-docente-latency">--</span>
                </div>
              </div>
              <div class="link-item" id="api-docente-item">
                <a href="http://localhost:4000/api/salud" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12h4l2-4 4 8 2-4h4"/></svg>
                  <div class="link-copy">
                    <div class="link-title">API docente salud</div>
                    <div class="link-meta">Backend local - 4000</div>
                  </div>
                  <span class="link-chip api">API</span>
                </a>
                <div class="link-note">Disponible cuando el backend docente esta activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-api-docente-dot"></span>
                  <span class="health-text" id="health-api-docente-text">Sin comprobar</span>
                  <span class="health-latency" id="health-api-docente-latency">--</span>
                </div>
              </div>
              <div class="link-item" id="api-portal-item">
                <a href="http://localhost:8080/api/portal/salud" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12h4l2-4 4 8 2-4h4"/></svg>
                  <div class="link-copy">
                    <div class="link-title">API portal alumno salud</div>
                    <div class="link-meta">Portal alumno - 8080</div>
                  </div>
                  <span class="link-chip api">API</span>
                </a>
                <div class="link-note">Disponible cuando el portal alumno esta activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-api-portal-dot"></span>
                  <span class="health-text" id="health-api-portal-text">Sin comprobar</span>
                  <span class="health-latency" id="health-api-portal-latency">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-status" class="tab-panel" data-panel="status" role="tabpanel" tabindex="0" aria-labelledby="tab-status" hidden>
      <div class="panel-grid">
        <div>
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v16H4V4zm2 2v4h12V6H6zm0 6v6h12v-6H6z"/>
              </svg>
              Estado general
            </h2>
            <div class="metrics">
              <div class="metric">
                <div class="label">Node</div>
                <div class="value" id="node">-</div>
              </div>
              <div class="metric">
                <div class="label">NPM</div>
                <div class="value" id="npm">-</div>
              </div>
              <div class="metric">
                <div class="label">Docker</div>
                <div class="value" id="docker">-</div>
              </div>
            </div>
            <div class="status-grid">
              <div>Procesos: <span id="running-status">-</span></div>
              <div>Modo: <span id="mode-status">-</span></div>
              <div>Proyecto: <span id="root-status">-</span></div>
              <div>Stack Docker: <span id="stack-state-status">-</span></div>
              <div>Conexión: <span id="connection-status">-</span></div>
              <div>Ultimo error: <span id="connection-error">-</span></div>
            </div>
          </div>

          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2l10 5-10 5L2 7l10-5zm-6 8v6c0 2.2 2.7 4 6 4s6-1.8 6-4v-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Instalacion local
            </h2>
            <div class="install-grid" id="install-grid" aria-live="polite">
              <div class="install-row"><div class="k">Version</div><div class="v mono" id="install-version">-</div></div>
              <div class="install-row"><div class="k">Dashboard</div><div class="v" id="install-dashboard">-</div></div>
              <div class="install-row"><div class="k">Ruta</div><div class="v mono" id="install-root">-</div></div>
              <div class="install-row"><div class="k">Logs</div><div class="v mono" id="install-logs">-</div></div>
              <div class="install-row"><div class="k">Runtime</div><div class="v mono" id="install-runtime">-</div></div>
            </div>
            <div class="toolbar toolbar-spaced toolbar-right" aria-label="Acciones de instalación">
              <button class="ghost-btn" id="refresh-install" type="button">Actualizar</button>
              <button class="ok" id="copy-install" type="button">Copiar</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 5h14v14H5V5zm2 2v10h10V7H7z"/>
              </svg>
              Salida y consola
            </h2>
            <div class="toolbar toolbar-grid" aria-label="Controles de salida">
              <div class="toolbar-group actions" aria-label="Acciones de salida">
                <button class="ok" id="toggle-logs" aria-expanded="false" aria-controls="log-shell">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7-7 7-1.4-1.4L15.2 13H5v-2h10.2l-4.6-4.6L12 5z"/></svg>
                  Mostrar salida
                </button>
                <button class="ghost-btn" id="open-logfile" type="button" title="Abrir logs/dashboard.log (log persistente)">
                  Abrir dashboard.log
                </button>
                <button class="danger" id="clear-logs">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12v2H6V7zm2 3h8l-1 9H9l-1-9zm3-6h2l1 2H10l1-2z"/></svg>
                  Limpiar salida
                </button>
              </div>

              <div class="toolbar-group switches" aria-label="Opciones de salida">
                <label class="toggle">
                  <input type="checkbox" id="full-logs" />
                  Logs detallados
                </label>
                <label class="toggle">
                  <input type="checkbox" id="auto-scroll" checked />
                  Auto-scroll
                </label>
                <label class="toggle">
                  <input type="checkbox" id="pause-updates" />
                  Pausar actualizaciones
                </label>
                <label class="toggle" title="En modo dev, reinicia el stack cuando cambien archivos del front/back">
                  <input type="checkbox" id="auto-restart" />
                  Auto-reinicio (dev)
                </label>
              </div>

              <div class="toolbar-group filter" aria-label="Filtro de salida">
                <input class="search" id="log-filter" placeholder="Filtrar texto" aria-label="Filtrar salida" />
                <button class="ghost-btn" id="clear-filter" type="button">Limpiar filtro</button>
              </div>
            </div>
            <div class="pills">
              <span class="pill" id="log-size">0 líneas</span>
              <span class="pill" id="raw-size">0 en bruto</span>
              <span class="pill" id="last-refresh-status">-</span>
              <span class="pill"><span class="dot" id="running-dot"></span> activo</span>
            </div>

            <div class="eventos-estado" aria-label="Eventos recientes del sistema">
              <div class="eventos-estado-cabecera">
                <div class="eventos-estado-titulo">Eventos recientes</div>
                <button class="ghost-btn" id="refrescar-eventos" type="button">Actualizar</button>
              </div>
              <div class="eventos-estado-subtitulo">Acciones y alertas detectadas por el dashboard (inicio/detención/reinicio/errores). Clic para ver detalles.</div>
              <div class="eventos-estado-lista" id="eventos-estado">
                <div class="evento-estado"><div class="mensaje"><div class="mensaje-titulo">Cargando eventos...</div></div></div>
              </div>
            </div>
            <div class="log-shell collapsed" id="log-shell">
              <div class="log-body" id="log" role="log" aria-label="Salida de consola" aria-live="off">Cargando...</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-db" class="tab-panel" data-panel="db" role="tabpanel" tabindex="0" aria-labelledby="tab-db" hidden>
      <div class="panel-grid">
        <div class="left-col">
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C7.6 2 4 3.8 4 6v12c0 2.2 3.6 4 8 4s8-1.8 8-4V6c0-2.2-3.6-4-8-4zm0 2c3.9 0 6 .9 6 2s-2.1 2-6 2-6-.9-6-2 2.1-2 6-2zm0 16c-3.9 0-6-.9-6-2v-2c1.5 1.1 4.1 1.7 6 1.7s4.5-.6 6-1.7v2c0 1.1-2.1 2-6 2zm0-6c-3.9 0-6-.9-6-2V9.9C7.5 11 10.1 11.6 12 11.6s4.5-.6 6-1.7V12c0 1.1-2.1 2-6 2z"/></svg>
              Base de datos (MongoDB)
            </h2>
            <p class="hint">Panel recomendado: <strong>mongo-express</strong>. Se protege con Basic Auth (configurable via <code>MONGOEXPRESS_USER</code>/<code>MONGOEXPRESS_PASS</code>).</p>

            <div class="pills" aria-label="Estado de mongo-express">
              <span class="pill"><span class="dot" id="db-dot"></span> mongo-express</span>
              <span class="pill" id="db-state">Sin comprobar</span>
              <span class="pill"><a id="db-url" href="http://127.0.0.1:8081/" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8081/</a></span>
            </div>

            <div class="toolbar toolbar-spaced">
              <div class="toolbar-group" aria-label="Acciones de base de datos">
                <button class="ghost-btn" id="refresh-db" type="button">Actualizar</button>
                <button class="ghost-btn" id="open-db" type="button">Abrir en navegador</button>
                <button class="ghost-btn" id="toggle-db-embed" type="button">Mostrar panel aquí</button>
              </div>
            </div>

            <div id="db-embed-wrap" class="db-embed-wrap" hidden>
              <iframe
                id="db-iframe"
                title="mongo-express"
                src="about:blank"
                class="db-iframe"
                loading="lazy"
                referrerpolicy="no-referrer"
              ></iframe>
            </div>

            <p class="hint hint-spaced">Si no aparece, inicia el stack (dev o prod) y vuelve a presionar <em>Actualizar</em>.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

    <script>
    // Small helper to access DOM elements.
    const $ = (id) => document.getElementById(id);

    // Small helper to set text safely.
    const establecerTexto = (id, value) => {
      const el = $(id);
      if (el) el.textContent = value;
    };

    // Identificador de UI (útil para confirmar que el HTML recargó cambios).
    // Nota: actualiza este valor cuando hagas cambios visibles al dashboard.
    const UI_REV = '2026-01-19.1';

    const THEME_STORAGE_KEY = 'seuDashboardTheme';

    function establecerColorMetaTema(color) {
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute('content', String(color || ''));
    }

    function calcularBloqueTiempo(date = new Date()) {
      const h = date.getHours();
      if (h >= 6 && h < 10) return 'dawn';
      if (h >= 10 && h < 17) return 'day';
      if (h >= 17 && h < 21) return 'dusk';
      return 'night';
    }

    function aplicarBloqueTiempo() {
      document.documentElement.dataset.time = calcularBloqueTiempo();
    }

    function calcularAnimo() {
      if (state.conexion === 'error') return 'error';
      const snapshot = obtenerSnapshotServicios();
      const expectedTotal = snapshot.items.filter((item) => item.expected).length;
      if (!expectedTotal) return 'info';
      if (snapshot.downCount > 0) return 'error';
      if (snapshot.okCount === expectedTotal) return 'ok';
      return 'warn';
    }

    function actualizarIndicadorSistema(mood) {
      const btn = $('system-indicator');
      if (!btn) return;

      const map = {
        ok: { label: 'Sistema: OK', hint: 'Todos los servicios esperados están activos.' },
        warn: { label: 'Sistema: Atención', hint: 'Servicios sin comprobar o estado parcial.' },
        error: { label: 'Sistema: Error', hint: 'Hay servicios esperados caídos o sin conexión.' },
        info: { label: 'Sistema: Info', hint: 'No hay servicios esperados activos (stack detenido).' }
      };
      const m = map[mood] ? mood : 'info';
      const text = `${map[m].label} · Click para ver Status`;
      btn.setAttribute('aria-label', text);
      btn.setAttribute('title', `${map[m].label}. ${map[m].hint} Click para ir a Status.`);
    }

    function aplicarAnimo() {
      const mood = calcularAnimo();
      document.documentElement.dataset.mood = mood;
      actualizarIndicadorSistema(mood);
    }

    function sincronizarMetaTemaActual() {
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      establecerColorMetaTema(theme === 'dark' ? '#02030a' : '#f8fafc');
    }

    function aplicarTema(theme) {
      const t = theme === 'dark' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
      sincronizarMetaTemaActual();
      const btn = $('theme-toggle');
      if (btn) btn.textContent = t === 'dark' ? 'Tema: Oscuro' : 'Tema: Claro';
    }

    function obtenerTemaPreferido() {
      try {
        const stored = String(localStorage.getItem(THEME_STORAGE_KEY) || '').trim();
        if (stored === 'dark' || stored === 'light') return stored;
      } catch {}
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function iniciarTema() {
      aplicarTema(obtenerTemaPreferido());
      aplicarBloqueTiempo();
      aplicarAnimo();

      // Si no hay preferencia guardada, reaccionar a cambios del sistema.
      try {
        const stored = String(localStorage.getItem(THEME_STORAGE_KEY) || '').trim();
        if (!stored && window.matchMedia) {
          const mq = window.matchMedia('(prefers-color-scheme: dark)');
          const onChange = () => aplicarTema(obtenerTemaPreferido());
          if (typeof mq.addEventListener === 'function') mq.addEventListener('change', onChange);
          else if (typeof mq.addListener === 'function') mq.addListener(onChange);
        }
      } catch {}

      const btn = $('theme-toggle');
      if (!btn) return;
      btn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        try { localStorage.setItem(THEME_STORAGE_KEY, next); } catch {}
        aplicarTema(next);
      });
    }

    function obtenerPestanaDesdeHash() {
      const raw = String(location.hash || '').replace(/^#/, '').trim();
      if (!raw) return null;
      const params = new URLSearchParams(raw.includes('=') ? raw : `tab=${raw}`);
      const tab = String(params.get('tab') || '').trim();
      if (tab === 'main' || tab === 'status' || tab === 'db') return tab;
      return null;
    }

    function establecerHashPestana(tabId) {
      try {
        const next = `tab=${encodeURIComponent(String(tabId || ''))}`;
        const current = String(location.hash || '').replace(/^#/, '');
        if (current === next) return;
        history.replaceState(null, '', `#${next}`);
      } catch {}
    }

    function registrarServiceWorker() {
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker
        .register('/sw.js', { scope: '/' })
        .then((reg) => {
          const promptUpdate = () => {
            if (!reg.waiting) return;
            mostrarToastAvanzado('Hay una actualización del dashboard lista.', 'info', {
              id: 'sw-update',
              title: 'Actualización',
              actionLabel: 'Actualizar',
              onAction: () => reg.waiting && reg.waiting.postMessage({ type: 'SKIP_WAITING' }),
              duration: 9000
            });
          };

          reg.update().catch(() => undefined);
          if (reg.waiting) promptUpdate();

          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                promptUpdate();
              }
            });
          });

          navigator.serviceWorker.addEventListener('controllerchange', () => {
            location.reload();
          });
        })
        .catch(() => undefined);
    }

    function normalizarValorModo(valor) {
      const v = String(valor || '').toLowerCase();
      return v === 'dev' || v === 'prod' || v === 'none' ? v : 'none';
    }

    function derivarModoVista(modoConfig, listaEjecucion) {
      const modoConfigNormalizado = normalizarValorModo(modoConfig);
      const enEjecucion = new Set(Array.isArray(listaEjecucion) ? listaEjecucion : []);
      const tieneDev = enEjecucion.has('dev');
      const tieneProd = enEjecucion.has('prod');

      // Si config indica dev/prod explicitamente, respetarlo.
      if (modoConfigNormalizado === 'dev' || modoConfigNormalizado === 'prod') return modoConfigNormalizado;

      // Si no, inferir segun lo que este en ejecucion.
      if (tieneDev && !tieneProd) return 'dev';
      if (tieneProd && !tieneDev) return 'prod';
      if (hasDev && hasProd) return 'dev';
      return 'none';
    }

    function formatearEtiquetaModo(modeValue) {
      const m = normalizarValorModo(modeValue);
      if (m === 'none') return 'Sin modo';
      return m.toUpperCase();
    }

    const ETIQUETAS_ENTORNO = {
      dev: 'Dev local',
      prod: 'Prod local',
      portal: 'Portal alumno'
    };

    const state = {
      mostrarCompleto: false,
      autoDesplazamiento: true,
      pausado: false,
      filtro: '',
      enEjecucion: new Set(),
      logsVisibles: false,
      pestanaActiva: 'main',
      modo: 'none',
      salud: {},
      ultimaSaludEn: 0,
      eventos: [],
      historialSalud: [],
      sesionIniciadaEn: Date.now(),
      haCargado: false,
      claveInfoWebDocente: 'webDocenteDev',
      conexion: 'unknown',
      ultimaConexionEn: 0,
      ultimoErrorConexion: '',
      ultimoToastErrorEn: 0,
      eventosOkRecientes: true,
      ultimoErrorEventos: '',
      logsOkRecientes: true,
      ultimoErrorLogs: '',
      autoReinicio: false,
      instalacion: null,
      mongoExpress: {
        url: 'http://127.0.0.1:8081/',
        alcanzable: false,
        estado: 0,
        ultimaRevisionEn: 0,
        error: ''
      },
      dbEmpotrada: false
    };

    const TIEMPO_MANTENER_MS = 1200;
    const MAX_EVENTOS = 6;
    const MAX_HISTORIAL_SALUD = 16;
    const VENTANA_EVENTOS_RECIENTES_MS = 15 * 60 * 1000;
    const LIMITE_SENALES = 8;
    const MAPA_NIVELES = {
      error: 'error',
      warn: 'warn',
      ok: 'ok',
      info: 'info',
      system: 'info'
    };

    function normalizarMensajeError(error) {
      if (error && typeof error === 'object' && 'message' in error && typeof error.message === 'string') {
        return error.message;
      }
      return 'Sin respuesta';
    }

    function establecerConexion(stateName, detail = '') {
      state.conexion = stateName;
      state.ultimaConexionEn = Date.now();
      state.ultimoErrorConexion = stateName === 'error' ? String(detail || 'Sin respuesta') : '';

      const chip = $('connection-chip');
      if (chip) {
        chip.className = `chip ${stateName === 'ok' ? 'ok' : stateName === 'error' ? 'error' : 'warn'}`;
        chip.textContent = `Conexión: ${stateName === 'ok' ? 'OK' : stateName === 'error' ? 'Error' : '-'}`;
      }

      establecerTexto('connection-status', stateName === 'ok' ? 'OK' : stateName === 'error' ? 'Error' : '-');
      establecerTexto('connection-error', stateName === 'error'
        ? recortarMensaje(state.ultimoErrorConexion, 90)
        : '-');

      aplicarAnimo();
    }

    function establecerChipPausa(pausado) {
      const chip = $('pausado-chip');
      if (!chip) return;
      chip.className = `chip ${pausado ? 'warn' : 'ok'}`;
      chip.textContent = pausado ? 'Actualización: Pausada' : 'Actualización: Activa';
    }

    function mostrarToastErrorSiAplica(text) {
      const now = Date.now();
      if (now - state.ultimoToastErrorEn < 9000) return;
      state.ultimoToastErrorEn = now;
      mostrarToast(text, 'error', { title: 'Error', id: 'error-generic', duration: 5200 });
    }

    async function api(path, body) {
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        return await res.json();
      } catch (error) {
        mostrarToastErrorSiAplica('No se pudo contactar al dashboard.');
        establecerConexion('error', normalizarMensajeError(error));
        return { ok: false };
      }
    }

    function formatearMs(ms) {
      if (!Number.isFinite(ms)) return '-';
      if (ms < 1000) return `${Math.round(ms)}ms`;
      const s = Math.round(ms / 100) / 10;
      if (s < 90) return `${s}s`;
      const m = Math.round(s / 6) / 10;
      return `${m}m`;
    }

    function recortarRuta(p, max = 88) {
      const s = String(p || '');
      if (!s) return '-';
      if (s.length <= max) return s;
      return s.slice(0, 22) + '…' + s.slice(-Math.max(10, max - 26));
    }

    async function refrescarInfoInstalacion() {
      try {
        const res = await fetch('/api/install');
        if (!res.ok) throw new Error('No se pudo cargar /api/install');
        const info = await res.json();
        state.instalacion = info;

        const version = (info && info.app && info.app.version) ? String(info.app.version) : '-';
        const name = (info && info.app && info.app.name) ? String(info.app.name) : '';
        const port = info && info.dashboard ? info.dashboard.port : 0;
        const mode = info && info.dashboard ? String(info.dashboard.mode || '-') : '-';
        const pid = info && info.dashboard ? String(info.dashboard.pid || '-') : '-';
        const startedAt = info && info.dashboard ? Number(info.dashboard.startedAt || 0) : 0;

        const logs = info && info.paths ? String(info.paths.logFile || '') : '';
        const root = info && info.paths ? String(info.paths.root || '') : '';
        const runtime = info && info.runtime ? `${info.runtime.nodeVersion || ''} | ${info.runtime.platform || ''}/${info.runtime.arch || ''}` : '';

        const logCfg = info && info.logs ? info.logs : null;
        const persist = logCfg ? String(logCfg.persistMode || '-') : '-';
        const flushMs = logCfg ? Number(logCfg.flushMs || 0) : 0;
        const keep = logCfg ? Number(logCfg.keepFiles || 0) : 0;
        const maxBytes = logCfg ? Number(logCfg.maxBytes || 0) : 0;

        const startedAgo = startedAt ? formatearMs(Date.now() - startedAt) : '-';

        const modeLabel = mode === '-' ? '-' : formatearEtiquetaModo(normalizarValorModo(mode));

        establecerTexto('install-version', name && version !== '-' ? `${name} v${version}` : (version !== '-' ? `v${version}` : '-'));
        establecerTexto('install-dashboard', `Modo: ${modeLabel} · Puerto: ${port || '-'} · PID: ${pid} · Inicio: hace ${startedAgo}`);
        establecerTexto('install-root', recortarRuta(root, 96));
        establecerTexto('install-logs', `${recortarRuta(logs, 96)}\nPersistencia: ${persist} · Vaciado: ${flushMs ? flushMs + 'ms' : '-'} · Rotación: ${maxBytes ? Math.round(maxBytes/1000) + 'KB' : '-'} · Retención: ${keep || '-'}`);
        establecerTexto('install-runtime', recortarRuta(runtime, 110));

        const versionChip = $('version-chip');
        if (versionChip) versionChip.textContent = `Versión: ${version !== '-' ? version : '-'}`;
        const uiChip = $('ui-chip');
        if (uiChip) uiChip.textContent = `UI: ${UI_REV}`;
        const portChip = $('port-chip');
        if (portChip) portChip.textContent = `Puerto: ${port || '-'}`;
      } catch (error) {
        establecerTexto('install-version', '-');
        establecerTexto('install-dashboard', 'No se pudo cargar la info de instalación.');
        mostrarToastErrorSiAplica('No se pudo cargar la info de instalación.');
      }
    }

    function mostrarToast(text, type = 'info', options = {}) {
      return mostrarToastAvanzado(String(text || ''), type, options || {});
    }

    function iconoToast(type) {
      if (type === 'ok') return 'OK';
      if (type === 'warn') return '!';
      if (type === 'error') return 'X';
      return 'i';
    }

    function escaparCss(value) {
      if (typeof value !== 'string') return '';
      if (window.CSS && typeof window.CSS.escape === 'function') return window.CSS.escape(value);
      return value.replace(/"/g, '\\"');
    }

    function cerrarToast(toast) {
      if (!toast || toast.classList.contains('out')) return;
      toast.classList.add('out');
      const remove = () => toast.remove();
      toast.addEventListener('animationend', remove, { once: true });
      setTimeout(remove, 260);
    }

    function mostrarToastAvanzado(text, type = 'info', options = {}) {
      const wrap = $('toast-wrap');
      if (!wrap) return;

      const title = typeof options.title === 'string' ? options.title : null;
      const id = typeof options.id === 'string' ? options.id : null;
      const actionLabel = typeof options.actionLabel === 'string' ? options.actionLabel : null;
      const onAction = typeof options.onAction === 'function' ? options.onAction : null;
      const duration = Math.max(1200, Number(options.duration || 2800));
      const maxToasts = 4;

      if (id) {
        const existing = wrap.querySelector(`.toast[data-id="${escaparCss(id)}"]`);
        if (existing) existing.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.style.setProperty('--toast-duration', `${duration}ms`);
      if (id) toast.dataset.id = id;

      const safeTitle = title || (type === 'error' ? 'Error' : type === 'warn' ? 'Atencion' : type === 'ok' ? 'Listo' : 'Info');

      toast.innerHTML = `
        <div class="toast-icon" aria-hidden="true">${iconoToast(type)}</div>
        <div class="toast-body">
          <div class="toast-title">${safeTitle}</div>
          <div class="toast-text"></div>
        </div>
        <div class="toast-actions">
          ${actionLabel ? '<button class="toast-btn action" type="button" data-toast-action></button>' : ''}
          <button class="toast-btn close" type="button" aria-label="Cerrar" data-toast-close>×</button>
        </div>
      `.trim();

      const textEl = toast.querySelector('.toast-text');
      if (textEl) textEl.textContent = String(text || '').trim();
      const actionBtn = toast.querySelector('[data-toast-action]');
      if (actionBtn && actionLabel) actionBtn.textContent = actionLabel;

      const closeBtn = toast.querySelector('[data-toast-close]');
      if (closeBtn) closeBtn.addEventListener('click', () => cerrarToast(toast));
      if (actionBtn && onAction) {
        actionBtn.addEventListener('click', () => {
          try { onAction(); } finally { cerrarToast(toast); }
        });
      }

      wrap.appendChild(toast);
      while (wrap.children.length > maxToasts) {
        const first = wrap.firstElementChild;
        if (first) first.remove();
      }

      let remaining = duration;
      let startedAt = Date.now();
      let timer = setTimeout(() => cerrarToast(toast), remaining);

      const pause = () => {
        if (!timer) return;
        clearTimeout(timer);
        timer = null;
        remaining -= Date.now() - startedAt;
        toast.classList.add('pausado');
      };

      const resume = () => {
        if (timer) return;
        remaining = Math.max(450, remaining);
        startedAt = Date.now();
        toast.classList.remove('pausado');
        timer = setTimeout(() => cerrarToast(toast), remaining);
      };

      toast.addEventListener('pointerenter', pause);
      toast.addEventListener('pointerleave', resume);

      return toast;
    }

    function mostrarEntradaToastAvanzado(text, type, options) {
      return mostrarToastAvanzado(text, type, options);
    }

    function refrescarTrasAccion({ forzarSalud = true } = {}) {
      refrescarEstado();
      if (forzarSalud) refrescarSalud(true);
      if (state.logsVisibles) refrescarLogs();
      refrescarSenales();
      if (state.pestanaActiva === 'status') refrescarEventos();
    }

    function programarPulsoRefresco() {
      refrescarTrasAccion({ forzarSalud: true });
      setTimeout(() => refrescarTrasAccion({ forzarSalud: true }), 900);
      setTimeout(() => refrescarTrasAccion({ forzarSalud: true }), 2400);
      setTimeout(() => refrescarTrasAccion({ forzarSalud: true }), 5200);
    }

    function formatearHora(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function normalizarNivel(level) {
      return MAPA_NIVELES[level] || 'info';
    }

    function recortarMensaje(text, limit = 140) {
      if (!text) return '';
      if (text.length <= limit) return text;
      return text.slice(0, limit).trim() + '...';
    }

    function renderizarAlerta(entry) {
      const card = $('alert-card');
      if (!card) return;
      const icon = $('alert-icon');
      const title = $('alert-title');
      const message = $('alert-message');
      const source = $('alert-source');
      const time = $('alert-time');
      if (!icon || !title || !message || !source || !time) return;

      if (!entry) {
        card.className = 'card wide alert-card ok';
        icon.textContent = 'OK';
        title.textContent = 'Sin alertas activas';
        message.textContent = 'No hay errores recientes en los servicios monitoreados.';
        source.textContent = 'Origen: -';
        time.textContent = 'Hora: -';
        return;
      }

      const level = normalizarNivel(entry.level);
      const isError = level === 'error';
      card.className = `card wide alert-card ${isError ? 'error' : ''}`.trim();
      icon.textContent = isError ? 'X' : '!';
      title.textContent = isError ? 'Error detectado' : 'Advertencia detectada';
      message.textContent = recortarMensaje(entry.text, 220);
      source.textContent = `Origen: ${entry.source || '-'}`;
      time.textContent = `Hora: ${entry.time || '-'}`;
    }

    function renderizarConteosSenales(counts) {
      establecerTexto('signal-error', String(counts.error || 0));
      establecerTexto('signal-warn', String(counts.warn || 0));
      establecerTexto('signal-ok', String(counts.ok || 0));
      establecerTexto('signal-info', String(counts.info || 0));
    }

    function renderizarFeedEventos(entries) {
      const feed = $('event-feed');
      if (!feed) return;
      feed.innerHTML = '';

      if (!entries.length) {
        const empty = document.createElement('li');
        empty.className = 'event-empty';
        empty.textContent = 'Sin mensajes recientes.';
        feed.appendChild(empty);
        return;
      }

      entries.forEach((entry) => {
        const level = normalizarNivel(entry.level);
        const item = document.createElement('li');
        item.className = `event-item ${level}`.trim();

        const dot = document.createElement('span');
        dot.className = 'event-dot';

        const text = document.createElement('div');
        text.className = 'event-text';

        const title = document.createElement('div');
        title.textContent = recortarMensaje(entry.text, 160);

        const meta = document.createElement('div');
        meta.className = 'event-meta';

        const metaLevel = document.createElement('span');
        metaLevel.textContent = `Nivel: ${level.toUpperCase()}`;
        const metaSource = document.createElement('span');
        metaSource.textContent = `Origen: ${entry.source || '-'}`;

        meta.appendChild(metaLevel);
        meta.appendChild(metaSource);
        text.appendChild(title);
        text.appendChild(meta);

        const time = document.createElement('span');
        time.className = 'event-time';
        time.textContent = entry.time || '-';

        item.appendChild(dot);
        item.appendChild(text);
        item.appendChild(time);
        feed.appendChild(item);
      });
    }

    function actualizarSenales(entries) {
      const counts = { error: 0, warn: 0, ok: 0, info: 0 };
      const safeEntries = Array.isArray(entries) ? entries : [];

      safeEntries.forEach((entry) => {
        const level = normalizarNivel(entry.level);
        if (level === 'error') counts.error += 1;
        else if (level === 'warn') counts.warn += 1;
        else if (level === 'ok') counts.ok += 1;
        else counts.info += 1;
      });

      renderizarConteosSenales(counts);

      const latestEntries = safeEntries.slice(-LIMITE_SENALES).reverse();
      renderizarFeedEventos(latestEntries);

      const critical = [...safeEntries].reverse().find((entry) => {
        const level = normalizarNivel(entry.level);
        return level === 'error' || level === 'warn';
      });

      renderizarAlerta(critical || null);
    }

    async function refrescarSenales() {
      try {
        const res = await fetch('/api/logs');
        const data = await res.json();
        state.logsOkRecientes = true;
        state.ultimoErrorLogs = '';
        actualizarSenales(data.entries || []);
      } catch (error) {
        state.logsOkRecientes = false;
        state.ultimoErrorLogs = normalizarMensajeError(error);
        actualizarSenales([]);
      }
    }

    function establecerPuntoEjecucion(active) {
      const dot = $('running-dot');
      if (!dot) return;
      dot.classList.toggle('active', active);
    }

    function establecerItemSalud(prefix, info, expected = true) {
      const dot = $(`health-${prefix}-dot`);
      const text = $(`health-${prefix}-text`);
      const latency = $(`health-${prefix}-latency`);
      if (!dot || !text || !latency) return;

      if (!expected) {
        dot.className = 'health-dot';
        text.textContent = 'Detenido';
        latency.textContent = '--';
        return;
      }

      if (!info || typeof info.ok !== 'boolean') {
        dot.className = 'health-dot';
        text.textContent = 'Sin comprobar';
        latency.textContent = '--';
        return;
      }

      const ok = info.ok;
      const statusLabel = ok ? 'Activo' : (info.status ? `Caido (HTTP ${info.status})` : 'Sin respuesta');
      dot.className = `health-dot ${ok ? 'ok' : 'down'}`;
      text.textContent = statusLabel;
      latency.textContent = typeof info.ms === 'number' ? `${info.ms} ms` : '--';
    }

    function renderizarEnEjecucion(list) {
      if (!Array.isArray(list) || list.length === 0) return '-';
      return list.map((item) => ETIQUETAS_ENTORNO[item] || item).join(', ');
    }

    function resolverVistaDocker(datos) {
      if (datos && typeof datos.dockerDisplay === 'string' && datos.dockerDisplay.trim()) return datos.dockerDisplay;
      if (datos && typeof datos.docker === 'string' && datos.docker.trim()) return datos.docker;
      return '-';
    }

    function resolverVistaStack(datos, listaEjecucion) {
      if (datos && typeof datos.stackDisplay === 'string' && datos.stackDisplay.trim()) return datos.stackDisplay;
      const stack = datos && datos.dockerState && datos.dockerState.stack ? datos.dockerState.stack : null;
      const estadoStack = stack && stack.state ? String(stack.state) : 'unknown';
      const ultimoError = stack && stack.lastError ? String(stack.lastError) : '';
      const enEjecucion = Array.isArray(listaEjecucion) ? listaEjecucion : [];
      const tieneTareaStack = enEjecucion.includes('dev') || enEjecucion.includes('prod') || enEjecucion.includes('dev-backend');
      const stackEnEjecucion = Boolean(stack && stack.running) || tieneTareaStack;

      if (estadoStack === 'error') return ultimoError || 'Error iniciando stack.';
      if (estadoStack === 'starting') return 'Iniciando stack Docker...';
      if (estadoStack === 'checking') return 'Comprobando stack Docker...';
      if (estadoStack === 'skipped') return 'Stack Docker ya está activo.';
      if (stackEnEjecucion) return 'Stack activo (procesos en ejecución).';
      return 'Stack detenido.';
    }

    function actualizarBotonEntorno(boton, enEjecucion) {
      if (!boton) return;
      const estadoEl = boton.querySelector('[data-state]');
      const subElemento = boton.querySelector('[data-sub]');

      boton.classList.toggle('active', enEjecucion);
      boton.classList.remove('pending');
      boton.removeAttribute('data-pending');

      if (estadoEl) estadoEl.textContent = enEjecucion ? 'Activo' : 'Detenido';
      if (subElemento) {
        subElemento.textContent = enEjecucion
          ? 'Mantener 1.2s para detener'
          : 'Mantener 1.2s para iniciar';
      }

      boton.setAttribute('aria-pressed', enEjecucion ? 'true' : 'false');
    }

    function actualizarBotonesEntorno() {
      document.querySelectorAll('[data-env]').forEach((boton) => {
        actualizarBotonEntorno(boton, state.enEjecucion.has(boton.dataset.env));
      });
    }

    function registrarEvento(tipo, etiqueta) {
      const entry = {
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        type: tipo,
        label: etiqueta,
        time: Date.now()
      };

      state.eventos.unshift(entry);
      if (state.eventos.length > MAX_EVENTOS) {
        state.eventos.splice(MAX_EVENTOS);
      }

      renderizarActividad();
      actualizarAnalitica();
    }

    function renderizarActividad() {
      const list = $('activity-list');
      if (!list) return;

      list.innerHTML = '';

      if (state.eventos.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'activity-empty';
        empty.textContent = 'Sin actividad reciente.';
        list.appendChild(empty);
        establecerTexto('last-event', 'Sin actividad reciente.');
        return;
      }

      state.eventos.forEach((entry) => {
        const li = document.createElement('li');
        li.className = 'activity-item';

        const dot = document.createElement('span');
        dot.className = `activity-dot ${entry.type === 'start' ? 'ok' : 'down'}`;

        const text = document.createElement('span');
        text.className = 'activity-text';
        text.textContent = `${entry.type === 'start' ? 'Inicio' : 'Detencion'}: ${entry.label}`;

        const time = document.createElement('span');
        time.className = 'activity-time';
        time.textContent = formatearHora(entry.time);

        li.appendChild(dot);
        li.appendChild(text);
        li.appendChild(time);
        list.appendChild(li);
      });

      const last = state.eventos[0];
      if (last) {
        establecerTexto('last-event', `Última acción: ${last.label} (${last.type === 'start' ? 'inicio' : 'detenido'})`);
      }
    }

    function obtenerSnapshotServicios() {
      const runningDevOrProd = state.enEjecucion.has('dev') || state.enEjecucion.has('prod');
      const webInfoKey = state.claveInfoWebDocente || 'webDocenteDev';
      const items = [
        {
          id: 'web-docente',
          expected: runningDevOrProd,
          info: state.salud?.[webInfoKey]
        },
        {
          id: 'api-docente',
          expected: runningDevOrProd,
          info: state.salud?.apiDocente
        },
        {
          id: 'api-portal',
          expected: state.enEjecucion.has('portal'),
          info: state.salud?.apiPortal
        }
      ];

      let okCount = 0;
      let downCount = 0;

      items.forEach((item) => {
        if (!item.expected) return;
        if (!item.info || typeof item.info.ok !== 'boolean') return;
        if (item.info.ok) okCount += 1;
        else downCount += 1;
      });

      return { items, okCount, downCount };
    }

    function actualizarResumenServicios() {
      const snapshot = obtenerSnapshotServicios();

      snapshot.items.forEach((item) => {
        const dot = $(`service-${item.id}-dot`);
        const badge = $(`service-${item.id}-badge`);
        if (!dot || !badge) return;

        if (!item.expected) {
          dot.className = 'service-dot';
          badge.className = 'service-badge';
          badge.textContent = 'Detenido';
          return;
        }

        if (!item.info || typeof item.info.ok !== 'boolean') {
          dot.className = 'service-dot';
          badge.className = 'service-badge';
          badge.textContent = 'Sin comprobar';
          return;
        }

        if (item.info.ok) {
          dot.className = 'service-dot ok';
          badge.className = 'service-badge ok';
          badge.textContent = 'Activo';
        } else {
          dot.className = 'service-dot down';
          badge.className = 'service-badge down';
          badge.textContent = 'Caido';
        }
      });

      return snapshot;
    }

    function renderizarHistorialSalud() {
      const container = $('health-history');
      if (!container) return;

      const okChip = $('health-last-ok');
      const downChip = $('health-last-down');
      const timeChip = $('health-last-time');

      container.innerHTML = '';

      if (state.historialSalud.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'chart-empty';
        empty.textContent = 'Sin historial de salud por ahora.';
        container.appendChild(empty);
        if (okChip) okChip.textContent = 'OK -';
        if (downChip) downChip.textContent = 'Caidas -';
        if (timeChip) timeChip.textContent = 'Ultimo: --';
        if (okChip) okChip.className = 'health-chip ok';
        if (downChip) downChip.className = 'health-chip down';
        return;
      }

      const lastIndex = state.historialSalud.length - 1;
      state.historialSalud.forEach((entry, index) => {
        const ratio = entry.total ? entry.okCount / entry.total : 0;
        const height = Math.max(12, Math.round(14 + ratio * 60));
        const bar = document.createElement('div');
        const statusClass = entry.downCount > 0 ? 'down' : 'ok';
        const latestClass = index === lastIndex ? 'latest' : '';
        bar.className = `mini-bar ${statusClass} ${latestClass}`.trim();
        bar.style.height = `${height}px`;
        bar.title = `${formatearHora(entry.ts)} | OK ${entry.okCount}/${entry.total}`;
        container.appendChild(bar);
      });

      const last = state.historialSalud[lastIndex];
      if (last) {
        const ratio = last.total ? last.okCount / last.total : 0;
        const ratioPct = Math.round(ratio * 100);
        if (okChip) okChip.textContent = `OK ${last.okCount}/${last.total} (${ratioPct}%)`;
        if (downChip) {
          downChip.textContent = `Caidas ${last.downCount}`;
          downChip.className = `health-chip ${last.downCount > 0 ? 'down' : 'ok'}`;
        }
        if (timeChip) timeChip.textContent = `Ultimo: ${formatearHora(last.ts)}`;
      }
    }

    function actualizarAnalitica() {
      const snapshot = actualizarResumenServicios();
      const expectedTotal = snapshot.items.filter((item) => item.expected).length;

      establecerTexto('health-ok', expectedTotal ? String(snapshot.okCount) : '-');
      establecerTexto('health-down', expectedTotal ? String(snapshot.downCount) : '-');

      const now = Date.now();
      const recentEvents = state.eventos.filter((entry) => now - entry.time <= VENTANA_EVENTOS_RECIENTES_MS).length;
      establecerTexto('recent-events', String(recentEvents));

      const minutes = Math.floor((now - state.sesionIniciadaEn) / 60000);
      establecerTexto('session-mins', minutes < 1 ? '<1 min' : `${minutes} min`);
    }

    function construirSnapshotSalud() {
      const snapshot = obtenerSnapshotServicios();
      const expectedTotal = snapshot.items.filter((item) => item.expected).length;
      if (!expectedTotal) return null;

      return {
        ts: Date.now(),
        okCount: snapshot.okCount,
        downCount: snapshot.downCount,
        total: expectedTotal
      };
    }

    function actualizarEnlaceWebDocente(mode) {
      const item = $('web-docente-item');
      const link = $('web-docente-link');
      const meta = $('web-docente-meta');
      const chip = $('web-docente-chip');
      const note = $('web-docente-note');
      if (!item || !link || !meta || !chip || !note) return;

      const runningDev = state.enEjecucion.has('dev');
      const runningProd = state.enEjecucion.has('prod');
      const normalized = String(mode || '').toLowerCase();

      let target = 'dev';
      if (runningDev && !runningProd) target = 'dev';
      else if (runningProd && !runningDev) target = 'prod';
      else if (runningDev && runningProd) target = normalized === 'prod' ? 'prod' : 'dev';
      else target = normalized === 'prod' ? 'prod' : 'dev';

      const isProd = target === 'prod';
      link.href = isProd ? 'http://localhost:4173' : 'http://localhost:5173';
      meta.textContent = isProd
        ? 'Prod local (Docker + serve) - 4173'
        : 'Dev local (Vite) - 5173';
      chip.textContent = isProd ? 'PROD' : 'DEV';
      chip.className = `link-chip ${isProd ? 'prod' : 'dev'}`;

      const any = runningDev || runningProd;
      item.classList.toggle('inactive', !any);

      if (!any) {
        note.textContent = 'No hay UI web activa. Inicia dev (5173) o prod (4173).';
      } else if (runningDev && runningProd) {
        note.textContent = `Dev y prod activos. Mostrando ${isProd ? 'prod' : 'dev'} según el modo actual.`;
      } else {
        note.textContent = `Detectado ${isProd ? 'prod' : 'dev'} activo. Acceso listo.`;
      }

      const infoKey = isProd ? 'webDocenteProd' : 'webDocenteDev';
      state.claveInfoWebDocente = infoKey;
      establecerItemSalud('web-docente', state.salud?.[infoKey], any);
    }

    async function refrescarSalud(forzar = false) {
      const now = Date.now();
      const reuse = !forzar && now - state.ultimaSaludEn < 4000;
      if (!reuse) state.ultimaSaludEn = now;

      if (!reuse) {
        try {
          const res = await fetch('/api/health');
          const data = await res.json();
          state.salud = data.services || {};
        } catch {
          state.salud = {};
        }

        const snapshot = construirSnapshotSalud();
        if (snapshot) {
          state.historialSalud.push(snapshot);
          if (state.historialSalud.length > MAX_HISTORIAL_SALUD) {
            state.historialSalud.splice(0, state.historialSalud.length - MAX_HISTORIAL_SALUD);
          }
          renderizarHistorialSalud();
        }
      }

      const runningDevOrProd = state.enEjecucion.has('dev') || state.enEjecucion.has('prod');
      establecerItemSalud('api-docente', state.salud.apiDocente, runningDevOrProd);
      establecerItemSalud('api-portal', state.salud.apiPortal, state.enEjecucion.has('portal'));
      actualizarEnlaceWebDocente(state.modo);
      actualizarAnalitica();
      aplicarAnimo();
    }

    function actualizarUiMongoExpress() {
      const dot = $('db-dot');
      const stateEl = $('db-state');
      const urlEl = $('db-url');
      const openBtn = $('open-db');
      const iframe = $('db-iframe');
      const wrap = $('db-embed-wrap');

      const url = state.mongoExpress?.url || 'http://127.0.0.1:8081/';
      const alcanzable = Boolean(state.mongoExpress?.alcanzable);
      const estado = Number(state.mongoExpress?.estado || 0);
      const error = String(state.mongoExpress?.error || '');

      if (urlEl) {
        urlEl.textContent = url;
        urlEl.href = url;
      }

      if (dot) dot.classList.toggle('active', alcanzable);

      if (stateEl) {
        if (alcanzable) {
          stateEl.textContent = estado ? `Disponible (HTTP ${estado})` : 'Disponible';
        } else {
          stateEl.textContent = error ? `No disponible (${error})` : 'No disponible';
        }
      }

      if (openBtn) {
        openBtn.disabled = !reachable;
        openBtn.title = reachable ? 'Abrir mongo-express en una pestaña' : 'mongo-express no esta disponible';
      }

      if (wrap) {
        wrap.hidden = !state.dbEmpotrada;
      }

      if (iframe && state.dbEmpotrada) {
        if (reachable) {
          const current = iframe.getAttribute('src') || '';
          if (current !== url) iframe.setAttribute('src', url);
        } else {
          iframe.setAttribute('src', 'about:blank');
        }
      }
    }

    async function refrescarMongoExpress(forzar = false) {
      const now = Date.now();
      const reuse = !forzar && now - (state.mongoExpress?.ultimaRevisionEn || 0) < 5000;
      if (reuse) {
        actualizarUiMongoExpress();
        return;
      }

      state.mongoExpress.ultimaRevisionEn = now;
      try {
        const res = await fetch('/api/mongo-express');
        const data = await res.json();
        state.mongoExpress.url = typeof data.url === 'string' ? data.url : state.mongoExpress.url;
        state.mongoExpress.alcanzable = Boolean(data.reachable);
        state.mongoExpress.estado = Number(data.status || 0);
        state.mongoExpress.error = '';
      } catch (error) {
        state.mongoExpress.alcanzable = false;
        state.mongoExpress.estado = 0;
        state.mongoExpress.error = normalizarMensajeError(error);
      }
      actualizarUiMongoExpress();
    }

    function establecerLogsVisibles(visible) {
      state.logsVisibles = visible;
      const shell = $('log-shell');
      const toggle = $('toggle-logs');
      if (!shell || !toggle) return;
      shell.classList.toggle('collapsed', !visible);
      toggle.setAttribute('aria-expanded', visible ? 'true' : 'false');
      toggle.innerHTML = '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7-7 7-1.4-1.4L15.2 13H5v-2h10.2l-4.6-4.6L12 5z"/></svg> ' + (visible ? 'Ocultar salida' : 'Mostrar salida');
      if (visible) refrescarLogs();
      else refrescarSenales();
    }

    function establecerPestana(nombre) {
      state.pestanaActiva = nombre;
      document.querySelectorAll('.tab-btn').forEach((btn) => {
        const isActive = btn.dataset.tab === nombre;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        btn.tabIndex = isActive ? 0 : -1;
      });
      document.querySelectorAll('.tab-panel').forEach((panel) => {
        const isActive = panel.dataset.panel === nombre;
        panel.classList.toggle('active', isActive);
        panel.hidden = !isActive;
      });
      if (nombre === 'status') {
        refrescarEventos();
        refrescarInfoInstalacion();
        if (state.logsVisibles) refrescarLogs();
      } else if (nombre === 'db') {
        refrescarMongoExpress(true);
      }

      establecerHashPestana(nombre);
    }

    function formatearEtiquetaEvento(valor) {
      if (!valor) return '-';
      return String(valor).replace(/_/g, ' ');
    }

    function parsearLogEstructurado(texto) {
      const crudo = String(texto || '').trim();
      if (!crudo) return null;
      const indiceLlave = crudo.indexOf('{');
      if (indiceLlave < 0) return null;
      const prefijo = crudo.slice(0, indiceLlave).replace(/\|\s*$/, '').trim();
      const parteJson = crudo.slice(indiceLlave).trim();
      if (!parteJson.startsWith('{')) return null;
      let carga = null;
      try {
        carga = JSON.parse(parteJson);
      } catch {
        return null;
      }

      const mensaje = typeof carga.msg === 'string' ? carga.msg.trim() : '';
      const componente = typeof carga.c === 'string' ? carga.c.trim() : '';
      const contexto = typeof carga.ctx === 'string' ? carga.ctx.trim() : '';
      const etiquetas = Array.isArray(carga.tags) ? carga.tags.map((tag) => String(tag)) : [];
      const atributos = carga.attr && typeof carga.attr === 'object' ? carga.attr : null;

      const partesSubtitulo = [];
      if (prefijo) partesSubtitulo.push(prefijo);
      if (componente) partesSubtitulo.push(componente);
      if (contexto) partesSubtitulo.push(contexto);
      if (etiquetas.length) partesSubtitulo.push(etiquetas.join(', '));

      const partesAtributos = [];
      if (atributos) {
        const entradas = Object.entries(atributos);
        for (const [clave, valor] of entradas) {
          if (partesAtributos.length >= 3) break;
          if (valor === null || typeof valor === 'undefined') continue;
          let formateado = '';
          if (typeof valor === 'string') formateado = valor;
          else if (typeof valor === 'number' || typeof valor === 'boolean') formateado = String(valor);
          else {
            try { formateado = JSON.stringify(valor); } catch { formateado = String(valor); }
          }
          formateado = recortarMensaje(formateado, 80);
          partesAtributos.push(`${clave}=${formateado}`);
        }
      }

      let detalle = '';
      try { detalle = JSON.stringify(carga, null, 2); } catch { detalle = parteJson; }

      return {
        titulo: mensaje || crudo,
        subtitulo: partesSubtitulo.join(' · '),
        resumenAtributos: partesAtributos.join(' · '),
        detalle,
        origen: prefijo
      };
    }

    function renderizarEventosEstado(entradas) {
      const contenedor = $('eventos-estado');
      if (!contenedor) return;
      contenedor.innerHTML = '';

      if (!state.eventosOkRecientes) {
        const item = document.createElement('div');
        item.className = 'evento-estado error';
        item.innerHTML = `<div class="mensaje"><div class="mensaje-titulo">Sin conexión: no se pudieron obtener eventos.</div></div>`;
        contenedor.appendChild(item);
        return;
      }

      const listaSegura = Array.isArray(entradas) ? entradas : [];
      const maximo = 10;
      const recortados = listaSegura.slice(0, maximo);
      if (recortados.length === 0) {
        const item = document.createElement('div');
        item.className = 'evento-estado';
        item.innerHTML = `<div class="mensaje"><div class="mensaje-titulo">Aún no hay eventos.</div></div>`;
        contenedor.appendChild(item);
        return;
      }

      const fragmento = document.createDocumentFragment();
      recortados.forEach((evento) => {
        const nivel = normalizarNivel(evento.level);
        const elemento = document.createElement('div');
        const tieneMeta = evento.meta && typeof evento.meta === 'object';

        const tipo = typeof evento.type === 'string' ? evento.type : 'evento';
        const origen = typeof evento.source === 'string' ? evento.source : '-';
        const hora = typeof evento.time === 'string' ? evento.time : '-';
        const texto = typeof evento.text === 'string' ? evento.text : '';

        const estructurado = parsearLogEstructurado(texto);
        const titulo = estructurado ? estructurado.titulo : texto;
        const subtitulo = estructurado ? estructurado.subtitulo : '';
        const resumenAtributos = estructurado ? estructurado.resumenAtributos : '';

        const bloquesDetalle = [];
        if (estructurado && estructurado.detalle) bloquesDetalle.push(estructurado.detalle);
        if (tieneMeta) {
          try { bloquesDetalle.push(JSON.stringify(evento.meta, null, 2)); } catch {}
        }
        const textoDetalle = bloquesDetalle.join('\n\n').trim();
        const tieneDetalles = Boolean(textoDetalle);

        const etiquetaNivel = nivel.toUpperCase();
        const etiquetaTipo = formatearEtiquetaEvento(tipo);
        const etiquetaOrigen = formatearEtiquetaEvento(origen);
        elemento.className = `evento-estado ${nivel} ${tieneDetalles ? 'con-detalles' : ''}`.trim();
        if (tieneDetalles) {
          elemento.setAttribute('tabindex', '0');
          elemento.setAttribute('role', 'button');
          elemento.setAttribute('aria-expanded', 'false');
        }

        elemento.innerHTML = `
          <div class="encabezado">
            <span class="hora">${hora}</span>
            <span class="pildora-nivel ${nivel}">${etiquetaNivel}</span>
            <span class="etiqueta">${etiquetaTipo}</span>
            <span class="etiqueta">${etiquetaOrigen}</span>
          </div>
          <div class="mensaje">
            <div class="mensaje-titulo"></div>
            <div class="mensaje-subtitulo"></div>
            <div class="mensaje-meta"></div>
          </div>
          <div class="detalles">
            <div class="detalles-titulo">Detalles</div>
            <pre class="detalles-cuerpo"></pre>
          </div>
        `.trim();

        const mensajeTitulo = elemento.querySelector('.mensaje-titulo');
        if (mensajeTitulo) mensajeTitulo.textContent = recortarMensaje(titulo, 200);

        const mensajeSubtitulo = elemento.querySelector('.mensaje-subtitulo');
        if (mensajeSubtitulo) {
          if (subtitulo) mensajeSubtitulo.textContent = subtitulo;
          else mensajeSubtitulo.remove();
        }

        const mensajeMeta = elemento.querySelector('.mensaje-meta');
        if (mensajeMeta) {
          if (resumenAtributos) mensajeMeta.textContent = resumenAtributos;
          else mensajeMeta.remove();
        }

        const encabezado = elemento.querySelector('.encabezado');
        if (encabezado && estructurado && estructurado.origen && estructurado.origen !== origen) {
          const origenExtra = document.createElement('span');
          origenExtra.className = 'etiqueta codigo';
          origenExtra.textContent = estructurado.origen;
          encabezado.appendChild(origenExtra);
        }

        const detalles = elemento.querySelector('.detalles');
        const detallesCuerpo = elemento.querySelector('.detalles-cuerpo');
        if (detalles && detallesCuerpo) {
          if (tieneDetalles) detallesCuerpo.textContent = textoDetalle;
          else detalles.remove();
        }

        if (tieneDetalles) {
          const alternar = () => {
            const siguiente = !elemento.classList.contains('abierto');
            elemento.classList.toggle('abierto', siguiente);
            elemento.setAttribute('aria-expanded', siguiente ? 'true' : 'false');
          };
          elemento.addEventListener('click', alternar);
          elemento.addEventListener('keydown', (eventoTecla) => {
            if (eventoTecla.key === 'Enter' || eventoTecla.key === ' ') {
              eventoTecla.preventDefault();
              alternar();
            }
          });
        }

        fragmento.appendChild(elemento);
      });

      contenedor.appendChild(fragmento);
    }

    async function refrescarEventos() {
      if (state.pestanaActiva !== 'status') return;
      try {
        const respuesta = await fetch('/api/events');
        const datos = await respuesta.json();
        state.eventosOkRecientes = true;
        state.ultimoErrorEventos = '';
        renderizarEventosEstado(datos.entries || []);
      } catch (error) {
        state.eventosOkRecientes = false;
        state.ultimoErrorEventos = normalizarMensajeError(error);
        renderizarEventosEstado([]);
      }
    }

    function vincularMantener(boton, alDisparar) {
      let idRaf = null;
      let inicio = 0;
      const mantenerMs = Number(boton.dataset.holdMs || TIEMPO_MANTENER_MS);
      let activo = false;

      const reiniciar = () => {
        boton.style.setProperty('--hold', 0);
        boton.classList.remove('is-holding');
        activo = false;
        if (idRaf) cancelAnimationFrame(idRaf);
        idRaf = null;
      };

      const paso = (ahora) => {
        const progreso = Math.min(1, (ahora - inicio) / mantenerMs);
        boton.style.setProperty('--hold', (progreso * 100).toFixed(2));
        if (progreso >= 1) {
          boton.classList.add('hold-done');
          setTimeout(() => boton.classList.remove('hold-done'), 420);
          reiniciar();
          alDisparar();
          return;
        }
        idRaf = requestAnimationFrame(paso);
      };

      const iniciarMantener = (evento) => {
        evento.preventDefault();
        const enfriamientoHasta = Number(boton.dataset.cooldownUntil || 0);
        if (enfriamientoHasta && Date.now() < enfriamientoHasta) return;
        if (activo) return;
        activo = true;
        boton.classList.add('is-holding');
        inicio = performance.now();
        idRaf = requestAnimationFrame(paso);
      };

      const cancelarMantener = () => {
        if (!activo) return;
        reiniciar();
      };

      boton.addEventListener('pointerdown', iniciarMantener);
      boton.addEventListener('pointerup', cancelarMantener);
      boton.addEventListener('pointerleave', cancelarMantener);
      boton.addEventListener('pointercancel', cancelarMantener);
      boton.addEventListener('keydown', (evento) => {
        if (evento.key === 'Enter' || evento.key === ' ') iniciarMantener(evento);
      });
      boton.addEventListener('keyup', cancelarMantener);
    }

    function sincronizarEventosEntorno(previo, actual) {
      previo.forEach((entorno) => {
        if (!actual.has(entorno)) registrarEvento('stop', ETIQUETAS_ENTORNO[entorno] || entorno);
      });
      actual.forEach((entorno) => {
        if (!previo.has(entorno)) registrarEvento('start', ETIQUETAS_ENTORNO[entorno] || entorno);
      });
    }

    async function refrescarEstado() {
      try {
        const respuesta = await fetch('/api/status');
        const datos = await respuesta.json();
        establecerConexion('ok');

      const listaEjecucion = Array.isArray(datos.running) ? datos.running : [];
      const conteoEjecucion = listaEjecucion.length;
      const ejecucionPrevia = new Set(state.enEjecucion);
      const vistaDocker = resolverVistaDocker(datos);
      const vistaStack = resolverVistaStack(datos, listaEjecucion);

      const modoMostrar = derivarModoVista(datos.mode, listaEjecucion);
      state.modo = modoMostrar;
      state.enEjecucion = new Set(listaEjecucion);

      establecerTexto('root', datos.root);
      establecerTexto('mode', formatearEtiquetaModo(modoMostrar));
      establecerTexto('running-count', String(conteoEjecucion));
      establecerTexto('running', renderizarEnEjecucion(listaEjecucion));
      establecerTexto('last-refresh', `Actualizado ${new Date().toLocaleTimeString()}`);

      establecerTexto('root-status', datos.root);
      establecerTexto('mode-status', formatearEtiquetaModo(modoMostrar));
      establecerTexto('running-status', renderizarEnEjecucion(listaEjecucion));
      establecerTexto('node', datos.node);
      establecerTexto('npm', datos.npm);
      establecerTexto('docker', vistaDocker);
      establecerTexto('docker-state-main', vistaDocker);
      establecerTexto('stack-state-main', vistaStack);
      establecerTexto('stack-state-status', vistaStack);
      establecerTexto('mode-chip', `Modo: ${formatearEtiquetaModo(modoMostrar)}`);
      establecerTexto('running-chip', `Procesos: ${conteoEjecucion}`);
      establecerTexto('port-chip', `Puerto: ${datos.port || '-'}`);
      establecerTexto('log-size', `${datos.logSize} líneas`);
      establecerTexto('raw-size', `${datos.rawSize} en bruto`);
      establecerTexto('last-refresh-status', `Actualizado ${new Date().toLocaleTimeString()}`);

      state.autoReinicio = Boolean(datos.autoRestart);
      const toggleAutoReinicio = $('auto-restart');
      if (toggleAutoReinicio) {
        toggleAutoReinicio.disabled = String(datos.modeConfig || datos.mode || '').toLowerCase() !== 'dev';
        toggleAutoReinicio.checked = state.autoReinicio;
      }

      establecerPuntoEjecucion(conteoEjecucion > 0);
      actualizarBotonesEntorno();

      if (state.haCargado) {
        sincronizarEventosEntorno(ejecucionPrevia, state.enEjecucion);
      }
      state.haCargado = true;

      const itemApiDocente = $('api-docente-item');
      if (itemApiDocente) {
        itemApiDocente.classList.toggle('inactive', !(state.enEjecucion.has('dev') || state.enEjecucion.has('prod')));
      }
      const itemApiPortal = $('api-portal-item');
      if (itemApiPortal) {
        itemApiPortal.classList.toggle('inactive', !state.enEjecucion.has('portal'));
      }

        await refrescarSalud();
        aplicarAnimo();
      } catch (error) {
        establecerConexion('error', normalizarMensajeError(error));
        mostrarToastErrorSiAplica('Sin conexión: no se pudo leer /api/status.');

        state.enEjecucion = new Set();
        state.modo = 'none';
        state.salud = {};

        establecerTexto('root', '-');
        establecerTexto('mode', '-');
        establecerTexto('running-count', '0');
        establecerTexto('running', '-');
        establecerTexto('last-refresh', '-');

        establecerTexto('root-status', '-');
        establecerTexto('mode-status', '-');
        establecerTexto('running-status', '-');
        establecerTexto('node', '-');
        establecerTexto('npm', '-');
        establecerTexto('docker', '-');
        establecerTexto('docker-state-main', '-');
        establecerTexto('stack-state-main', '-');
        establecerTexto('stack-state-status', '-');
        establecerTexto('mode-chip', 'Modo: -');
        establecerTexto('running-chip', 'Procesos: -');

        establecerPuntoEjecucion(false);
        actualizarBotonesEntorno();
        actualizarEnlaceWebDocente(state.modo);
        actualizarAnalitica();

        renderizarAlerta({
          level: 'error',
          text: 'No hay conexión con el servidor del dashboard. Inicia scripts/launcher-dashboard para habilitar /api/*.',
          source: 'dashboard',
          time: new Date().toLocaleTimeString()
        });

        aplicarAnimo();
      }
    }

    async function establecerAutoReinicio(valor) {
      await api('/api/config', { autoRestart: Boolean(valor) });
      refrescarEstado();
    }

    function renderizarLogs(entradas) {
      const filtro = state.filtro.trim().toLowerCase();
      const contenedorLog = $('log');
      if (!contenedorLog) return;
      contenedorLog.innerHTML = '';

      if (!state.logsOkRecientes) {
        const offline = document.createElement('div');
        offline.className = 'log-line';
        offline.textContent = 'Sin conexión: no se pudo obtener la salida de logs.';
        contenedorLog.appendChild(offline);
        return;
      }

      const entradasSeguras = Array.isArray(entradas) ? entradas : [];
      const totalEntradas = entradasSeguras.length;

      const fragmento = document.createDocumentFragment();
      let visibles = 0;

      entradasSeguras.forEach((entrada) => {
        const textoMeta = entrada && entrada.meta && typeof entrada.meta === 'object'
          ? (() => { try { return JSON.stringify(entrada.meta); } catch { return ''; } })()
          : '';
        const texto = `${entrada.time} ${entrada.source} ${entrada.level} ${entrada.text} ${textoMeta}`;
        if (filtro && !texto.toLowerCase().includes(filtro)) return;

        const linea = document.createElement('div');
        const tieneMeta = entrada && entrada.meta && typeof entrada.meta === 'object';
        linea.className = `log-line ${entrada.level} ${tieneMeta ? 'has-meta' : ''}`.trim();

        const meta = document.createElement('span');
        meta.className = 'meta';
        meta.textContent = `[${entrada.time}] [${entrada.source}]`;

        const etiquetas = document.createElement('span');
        etiquetas.className = 'meta-tag';
        const pildora = document.createElement('span');
        pildora.className = 'pill';
        pildora.textContent = String(entrada.level || 'info').toUpperCase();
        etiquetas.appendChild(pildora);

        const contenido = document.createElement('span');
        contenido.textContent = ` ${entrada.text}`;

        linea.appendChild(meta);
        linea.appendChild(etiquetas);
        linea.appendChild(contenido);

        if (tieneMeta) {
          const detalles = document.createElement('div');
          detalles.className = 'meta-json';
          try { detalles.textContent = JSON.stringify(entrada.meta, null, 2); } catch { detalles.textContent = ''; }
          linea.appendChild(detalles);
          linea.addEventListener('click', () => {
            linea.classList.toggle('open');
          });
        }

        fragmento.appendChild(linea);
        visibles += 1;
      });

      if (visibles === 0) {
        const empty = document.createElement('div');
        empty.className = 'log-line';
        if (totalEntradas === 0 && !filtro) {
          empty.textContent = 'Aún no hay logs. Inicia un entorno o espera actividad.';
        } else {
          empty.textContent = 'Sin salida para el filtro actual.';
        }
        fragmento.appendChild(empty);
      }

      contenedorLog.appendChild(fragmento);

      if (state.autoDesplazamiento) {
        contenedorLog.scrollTop = contenedorLog.scrollHeight;
      }
    }

    async function refrescarLogs() {
      if (!state.logsVisibles) return;
      try {
        const query = state.mostrarCompleto ? '/api/logs?full=1' : '/api/logs';
        const res = await fetch(query);
        const data = await res.json();
        const entries = data.entries || [];
        state.logsOkRecientes = true;
        state.ultimoErrorLogs = '';
        renderizarLogs(entries);
        actualizarSenales(entries);
      } catch (error) {
        state.logsOkRecientes = false;
        state.ultimoErrorLogs = normalizarMensajeError(error);
        mostrarToastErrorSiAplica('No se pudo obtener la salida de logs.');
        renderizarLogs([]);
        actualizarSenales([]);
      }
    }

    // Tab switching.
    const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
    tabButtons.forEach((button, index) => {
      button.addEventListener('click', () => establecerPestana(button.dataset.tab));
      button.addEventListener('keydown', (event) => {
        const key = event.key;
        if (!['ArrowLeft', 'ArrowRight', 'Home', 'End', 'Enter', ' '].includes(key)) return;
        event.preventDefault();

        const last = tabButtons.length - 1;
        const go = (nextIndex) => {
          const next = tabButtons[nextIndex];
          next.focus();
          establecerPestana(next.dataset.tab);
        };

        if (key === 'ArrowLeft') go(index === 0 ? last : index - 1);
        if (key === 'ArrowRight') go(index === last ? 0 : index + 1);
        if (key === 'Home') go(0);
        if (key === 'End') go(last);
        if (key === 'Enter' || key === ' ') establecerPestana(button.dataset.tab);
      });
    });

    // Botones de entornos (mantener para iniciar/detener).
    document.querySelectorAll('[data-env]').forEach((boton) => {
      vincularMantener(boton, () => {
        const entorno = boton.dataset.env;
        const enEjecucion = state.enEjecucion.has(entorno);
        boton.dataset.cooldownUntil = String(Date.now() + 2200);
        boton.dataset.pending = enEjecucion ? 'stop' : 'start';
        boton.classList.add('pending');
        const subElemento = boton.querySelector('[data-sub]');
        if (subElemento) subElemento.textContent = enEjecucion ? 'Deteniendo...' : 'Iniciando...';

        mostrarToast(enEjecucion ? `Deteniendo ${entorno}...` : `Iniciando ${entorno}...`, 'info', {
          id: `env-${entorno}-pending`,
          title: 'Acción solicitada',
          duration: 3200,
          actionLabel: 'Abrir logs',
          onAction: () => {
            establecerPestana('status');
            establecerLogsVisibles(true);
            refrescarLogs();
          }
        });

        const endpoint = enEjecucion ? '/api/stop' : '/api/start';
        api(endpoint, { task: entorno }).then((res) => {
          if (res && res.ok === false) {
            mostrarToast(`No se pudo ejecutar la acciónón en ${entorno}.`, 'error', {
              id: `env-${entorno}-error`,
              title: 'Error',
              duration: 5200
            });
            return;
          }
          mostrarToast('Solicitud enviada. Actualizando estado...', 'ok', {
            id: `env-${entorno}-sent`,
            title: 'Listo',
            duration: 2200
          });
          programarPulsoRefresco();
        });
      });
    });

    // Botones de reinicio (mantener para ejecutar).
    document.querySelectorAll('[data-restart][data-hold-ms]').forEach((boton) => {
      vincularMantener(boton, () => {
        const objetivo = boton.dataset.restart;
        boton.dataset.cooldownUntil = String(Date.now() + 6500);
        boton.classList.add('pending');

        mostrarToast(`Reiniciando ${objetivo}...`, 'warn', {
          id: `restart-${objetivo}-pending`,
          title: 'Reinicio',
          duration: 4200,
          actionLabel: 'Ver estado',
          onAction: () => {
            establecerPestana('status');
            refrescarEstado();
            refrescarSalud(true);
          }
        });

        api('/api/restart', { task: objetivo }).then((res) => {
          if (res && res.ok === false) {
            mostrarToast(`No se pudo reiniciar ${objetivo}.`, 'error', {
              id: `restart-${objetivo}-error`,
              title: 'Error',
              duration: 5200
            });
            boton.classList.remove('pending');
            return;
          }
          mostrarToast('Reinicio solicitado. Actualizando...', 'ok', {
            id: `restart-${objetivo}-sent`,
            title: 'Listo',
            duration: 2400
          });
          programarPulsoRefresco();
          setTimeout(() => boton.classList.remove('pending'), 6500);
        });
      });
    });

    // Mantener para ejecutar acciones destructivas.
    document.querySelectorAll('[data-run][data-hold-ms]').forEach((boton) => {
      vincularMantener(boton, () => {
        const tarea = boton.dataset.run;
        boton.dataset.cooldownUntil = String(Date.now() + 2500);
        boton.classList.add('pending');
        mostrarToast('Ejecutando acción segura...', 'warn', {
          id: `run-${tarea}-pending`,
          title: 'Acción segura',
          duration: 3800,
          actionLabel: 'Abrir logs',
          onAction: () => {
            establecerPestana('status');
            establecerLogsVisibles(true);
            refrescarLogs();
          }
        });
        api('/api/run', { task: tarea }).then((res) => {
          if (res && res.ok === false) {
            mostrarToast('No se pudo ejecutar la acción.', 'error', { id: `run-${tarea}-error`, title: 'Error', duration: 5200 });
            boton.classList.remove('pending');
            return;
          }
          mostrarToast('Acción enviada. Actualizando...', 'ok', { id: `run-${tarea}-sent`, title: 'Listo', duration: 2200 });
          programarPulsoRefresco();
          setTimeout(() => boton.classList.remove('pending'), 2500);
        });
      });
    });

    // Ejecución inmediata para acciones no destructivas.
    document.querySelectorAll('[data-run]:not([data-hold-ms])').forEach((boton) => {
      boton.addEventListener('click', () => {
        const tarea = boton.dataset.run;
        boton.dataset.cooldownUntil = String(Date.now() + 1200);
        mostrarToast('Ejecutando...', 'info', { id: `run-${tarea}-pending`, title: 'Acción', duration: 2600 });
        api('/api/run', { task: tarea }).then((res) => {
          if (res && res.ok === false) {
            mostrarToast('No se pudo ejecutar.', 'error', { id: `run-${tarea}-error`, title: 'Error', duration: 5200 });
            return;
          }
          mostrarToast('Acción enviada. Actualizando...', 'ok', { id: `run-${tarea}-sent`, title: 'Listo', duration: 2000 });
          programarPulsoRefresco();
        });
      });
    });

    const botonLimpiar = $('clear-logs');
    if (botonLimpiar) {
      botonLimpiar.addEventListener('click', async () => {
        await api('/api/logs/clear');
        mostrarToast('Logs limpiados', 'ok');
        refrescarLogs();
        refrescarEstado();
        refrescarSenales();
      });
    }

    const botonAlternarLogs = $('toggle-logs');
    if (botonAlternarLogs) {
      botonAlternarLogs.addEventListener('click', () => {
        establecerLogsVisibles(!state.logsVisibles);
      });
    }

    const alertaAbrirLogs = $('alert-open-logs');
    if (alertaAbrirLogs) {
      alertaAbrirLogs.addEventListener('click', () => {
        establecerPestana('status');
        establecerLogsVisibles(true);
      });
    }

    // Controles de UI.
    const logsCompletos = $('full-logs');
    if (logsCompletos) {
      logsCompletos.addEventListener('change', (event) => {
        state.mostrarCompleto = event.target.checked;
        refrescarLogs();
      });
    }

    const autoDesplazamiento = $('auto-scroll');
    if (autoDesplazamiento) {
      autoDesplazamiento.addEventListener('change', (event) => {
        state.autoDesplazamiento = event.target.checked;
      });
    }

    const pausarActualizaciones = $('pause-updates');
    if (pausarActualizaciones) {
      pausarActualizaciones.addEventListener('change', (event) => {
        state.pausado = event.target.checked;
        establecerChipPausa(state.pausado);
        mostrarToast(state.pausado ? 'Actualizaciones pausadas' : 'Actualizaciones reanudadas', state.pausado ? 'warn' : 'ok');
      });
    }

    const toggleAutoReinicio = $('auto-restart');
    if (toggleAutoReinicio) {
      toggleAutoReinicio.addEventListener('change', (event) => {
        const value = event.target.checked;
        mostrarToast(value ? 'Auto-reinicio activado' : 'Auto-reinicio desactivado', value ? 'ok' : 'warn');
        establecerAutoReinicio(value);
      });
    }

    const indicadorSistema = $('system-indicator');
    if (indicadorSistema) {
      indicadorSistema.addEventListener('click', () => {
        establecerPestana('status');
      });
    }

    const filtroLogs = $('log-filter');
    if (filtroLogs) {
      filtroLogs.addEventListener('input', (event) => {
        state.filtro = event.target.value;
        refrescarLogs();
      });
    }

    const limpiarFiltro = $('clear-filter');
    if (limpiarFiltro) {
      limpiarFiltro.addEventListener('click', () => {
        state.filtro = '';
        const input = $('log-filter');
        if (input) input.value = '';
        refrescarLogs();
      });
    }

    const botonAbrirLog = $('open-logfile');
    if (botonAbrirLog) {
      botonAbrirLog.addEventListener('click', () => {
        window.open('/api/logfile', '_blank', 'noopener,noreferrer');
      });
    }

    const botonRefrescarEventos = $('refrescar-eventos');
    if (botonRefrescarEventos) {
      botonRefrescarEventos.addEventListener('click', () => refrescarEventos());
    }

    const botonRefrescarInstalacion = $('refresh-install');
    if (botonRefrescarInstalacion) {
      botonRefrescarInstalacion.addEventListener('click', () => refrescarInfoInstalacion());
    }

    const botonRefrescarDb = $('refresh-db');
    if (botonRefrescarDb) {
      botonRefrescarDb.addEventListener('click', () => refrescarMongoExpress(true));
    }

    const botonAbrirDb = $('open-db');
    if (botonAbrirDb) {
      botonAbrirDb.addEventListener('click', () => {
        if (!state.mongoExpress?.alcanzable) return;
        window.open(state.mongoExpress.url || 'http://127.0.0.1:8081/', '_blank', 'noopener,noreferrer');
      });
    }

    const botonAlternarDbEmpotrada = $('toggle-db-embed');
    if (botonAlternarDbEmpotrada) {
      botonAlternarDbEmpotrada.addEventListener('click', () => {
        state.dbEmpotrada = !state.dbEmpotrada;
        botonAlternarDbEmpotrada.textContent = state.dbEmpotrada ? 'Ocultar panel aquí' : 'Mostrar panel aquí';
        actualizarUiMongoExpress();
        if (state.pestanaActiva === 'db') refrescarMongoExpress(true);
      });
    }

    const botonCopiarInstalacion = $('copy-install');
    if (botonCopiarInstalacion) {
      botonCopiarInstalacion.addEventListener('click', async () => {
        try {
          const info = state.instalacion ? JSON.stringify(state.instalacion, null, 2) : 'Sin datos de instalación.';
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(info);
          } else {
            const ta = document.createElement('textarea');
            ta.value = info;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
          }
          mostrarToast('Datos de instalación copiados', 'ok', { id: 'install-copied', title: 'Copiado', duration: 2200 });
        } catch {
          mostrarToast('No se pudo copiar al portapapeles', 'warn', { id: 'install-copy-fail', title: 'Aviso', duration: 3200 });
        }
      });
    }

    // Carga inicial y refresco periódico.
    iniciarTema();
    establecerTexto('ui-chip', `UI: ${UI_REV}`);
    registrarServiceWorker();

    const initialTab = obtenerPestanaDesdeHash();
    if (initialTab) state.pestanaActiva = initialTab;
    establecerPestana(state.pestanaActiva);
    establecerHashPestana(state.pestanaActiva);

    window.addEventListener('hashchange', () => {
      const tab = obtenerPestanaDesdeHash();
      if (!tab || tab === state.pestanaActiva) return;
      establecerPestana(tab);
    });

    setInterval(() => aplicarBloqueTiempo(), 60 * 1000);
    establecerChipPausa(false);
    establecerConexion('unknown');
    establecerLogsVisibles(false);
    renderizarActividad();
    renderizarHistorialSalud();
    refrescarEstado();
    refrescarInfoInstalacion();
    refrescarSenales();
    actualizarUiMongoExpress();

    setInterval(() => {
      if (state.pausado) return;
      refrescarEstado();
      if (state.logsVisibles) refrescarLogs();
      else refrescarSenales();
      if (state.pestanaActiva === 'status') refrescarEventos();
      if (state.pestanaActiva === 'db') refrescarMongoExpress();
    }, 3000);
  </script>
</body>
</html>











































































































