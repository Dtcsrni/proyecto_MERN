%%{init: {'theme':'base','themeVariables':{'background':'#FFFFFF','primaryColor':'#EAF2FF','primaryTextColor':'#0B1220','primaryBorderColor':'#1E3A8A','lineColor':'#1F2937','secondaryColor':'#E8FFF2','tertiaryColor':'#FFF4E5','fontFamily':'Arial','fontSize':'15px'}}}%%
%% Diagrama: secuencia real de login usando nombres de funciones del codigo.
sequenceDiagram
    actor U as Usuario
    participant FE as login.tsx
    participant AUTH as iniciarSesion en ProveedorAutenticacion
    participant API as consultarApi
    participant BE as POST /api/auth/login
    participant DB as Usuario model
    Note over FE,AUTH: FE dispara iniciarSesion(correo, contrasena) desde el formulario de login.

    U->>FE: enviar correo y contrasena
    FE->>AUTH: iniciarSesion(correo, contrasena)
    AUTH->>API: consultarApi /api/auth/login
    API->>BE: POST body correo contrasena
    BE->>DB: Usuario.findOne correoNormalizado activo true
    DB-->>BE: usuario + hashContrasena + rol
    BE->>BE: bcrypt.compare contrasena hashContrasena
    Note over BE: Si coincide, se construye usuarioToken y se firma con firmarToken().

    alt Credenciales validas
        BE->>BE: firmarToken usuarioToken
        BE->>BE: establecerCookieSesion respuesta tokenAcceso
        BE-->>API: 200 usuario
        API-->>AUTH: respuesta usuario
        AUTH->>AUTH: setUsuario respuesta.usuario
        AUTH-->>FE: ok
        FE-->>U: sesion iniciada
        Note over AUTH,API: consultarApi incluye credentials include para mantener cookie de sesion.
    else Credenciales invalidas
        BE-->>API: 401 mensaje
        API-->>AUTH: throw Error mensaje
        AUTH-->>FE: error
        FE-->>U: mostrar error
    end
