%%{init: {'theme':'base','flowchart': {'curve': 'linear', 'nodeSpacing': 60, 'rankSpacing': 65},'themeVariables':{'background':'#FFFFFF','primaryColor':'#F3F7FF','primaryTextColor':'#0A0F1A','primaryBorderColor':'#1D4ED8','lineColor':'#0F172A','secondaryColor':'#EAFBF3','tertiaryColor':'#FFF4E5','fontFamily':'Arial','fontSize':'17px'}}}%%
%% Diagrama: actividad de autorizacion backend en rutas protegidas.
%% Referencias: autenticarJWT(), cargarUsuarioVigente(), autorizarRoles().
flowchart TD
    A[autenticarJWT solicitud respuesta siguiente] --> B{tokenAcceso en solicitud.cookies?}
    B -- No --> R401A[respuesta.status 401 No autenticado]
    B -- Si --> C{verificarToken tokenAcceso}
    C -- Error --> R401B[respuesta.clearCookie tokenAcceso + 401]
    C -- Ok --> D[cargarUsuarioVigente usuarioToken]
    D --> E{usuarioVigente existe?}
    E -- No --> R401C[respuesta.clearCookie tokenAcceso + 401]
    E -- Si --> H[solicitud.usuario = usuarioVigente]
    H --> F{autorizarRoles rolesPermitidos}
    F -- No --> R403[respuesta.status 403 Acceso denegado por rol]
    F -- Si --> G[siguiente]
    N2[NOTA: el rol se actualiza por request porque solicitud.usuario se carga desde DB]
    N2 -.-> H

    classDef proceso fill:#F3F7FF,stroke:#1D4ED8,stroke-width:2px,color:#0A0F1A;
    classDef decision fill:#E8F0FF,stroke:#1E3A8A,stroke-width:2.2px,color:#0A0F1A;
    classDef error fill:#FFECEC,stroke:#B91C1C,stroke-width:2.2px,color:#7F1D1D;
    classDef ok fill:#ECFDF3,stroke:#15803D,stroke-width:2.2px,color:#14532D;
    classDef nota fill:#FFF8E7,stroke:#B45309,stroke-width:1.8px,color:#7C2D12;

    class A,D proceso;
    class B,C,E,F decision;
    class R401A,R401B,R401C,R403 error;
    class G ok;
    class N2 nota;
