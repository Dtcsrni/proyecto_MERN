%%{init: {'theme':'base','themeVariables':{'background':'#FFFFFF','primaryColor':'#EAF2FF','primaryTextColor':'#0B1220','primaryBorderColor':'#1E3A8A','lineColor':'#1F2937','secondaryColor':'#E8FFF2','tertiaryColor':'#FFF4E5','fontFamily':'Arial','fontSize':'15px'}}}%%
%% Diagrama: restauracion de sesion con RBAC estricta en /api/auth/me.
sequenceDiagram
    participant FE as ProveedorAutenticacion
    participant API as consultarApi
    participant BE as GET /api/auth/me
    participant MW as autenticarJWT
    participant DB as Usuario model
    Note over FE,API: useEffect en ProveedorAutenticacion llama consultarApi("/api/auth/me").

    FE->>API: consultarApi /api/auth/me
    API->>BE: GET con credentials include
    BE->>MW: autenticarJWT solicitud respuesta siguiente
    MW->>MW: tokenAcceso solicitud.cookies?.tokenAcceso
    MW->>MW: verificarToken tokenAcceso
    Note over MW: Si tokenAcceso no existe o verificarToken falla => clearCookie + 401.

    alt JWT valido
        MW->>MW: usuarioToken = verificarToken
        MW->>MW: cargarUsuarioVigente usuarioToken
        MW->>DB: Usuario.findOne _id desdeToken.id activo true
        alt Usuario vigente
            DB-->>MW: usuario correo rol
            MW->>MW: solicitud.usuario = usuarioVigente
            MW-->>BE: siguiente()
            BE-->>API: 200 usuario solicitud.usuario
            API-->>FE: respuesta usuario
            FE->>FE: setUsuario respuesta.usuario
            Note over FE: UI queda autenticada usando rol vigente desde DB.
        else Usuario inactivo o ausente
            DB-->>MW: null
            MW->>MW: respuesta.clearCookie tokenAcceso
            MW-->>API: 401 Sesion no valida o cuenta inactiva
            API-->>FE: throw Error
            FE->>FE: setUsuario null
        end
    else JWT invalido o expirado
        MW->>MW: respuesta.clearCookie tokenAcceso
        MW-->>API: 401 Token invalido o expirado
        API-->>FE: throw Error
        FE->>FE: setUsuario null
    end

    FE->>FE: setCargando(false)
