name: Package Images

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: package-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  empaquetado:
    name: Empaquetar imágenes Docker
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Etapa package (Docker build)
        run: |
          docker build -f apps/backend/Dockerfile -t evaluapro-backend:${{ github.sha }} .
          docker build -f apps/frontend/Dockerfile -t evaluapro-frontend:${{ github.sha }} .
          docker build -f apps/portal_alumno_cloud/Dockerfile -t evaluapro-portal:${{ github.sha }} .

      - name: Exportar IDs de imágenes
        run: |
          {
            echo "evaluapro-backend $(docker image inspect evaluapro-backend:${{ github.sha }} --format='{{.Id}}')"
            echo "evaluapro-frontend $(docker image inspect evaluapro-frontend:${{ github.sha }} --format='{{.Id}}')"
            echo "evaluapro-portal $(docker image inspect evaluapro-portal:${{ github.sha }} --format='{{.Id}}')"
          } > image-digests.txt

      - name: Publicar artefacto
        uses: actions/upload-artifact@v4
        with:
          name: image-digests
          path: image-digests.txt
