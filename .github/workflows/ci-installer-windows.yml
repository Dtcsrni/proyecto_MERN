name: CI Installer Windows

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: ci-installer-windows-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  installer_windows:
    name: Installer Windows (MSI + Bundle)
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: |
            package-lock.json
            apps/backend/package-lock.json
            apps/frontend/package-lock.json
            apps/portal_alumno_cloud/package-lock.json

      - name: Etapa setup
        run: npm ci

      - name: Instalar WiX CLI estable (v6+)
        shell: powershell
        run: |
          winget install --id WiXToolset.WiXCLI --accept-source-agreements --accept-package-agreements

      - name: Registrar WiX en PATH
        shell: powershell
        run: |
          $wixBin = 'C:\Program Files\WiX Toolset v6.0\bin'
          if (-not (Test-Path $wixBin)) { throw "No se encontro WiX en $wixBin" }
          "$wixBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          & "$wixBin\wix.exe" --version

      - name: Etapa policy-check WiX
        run: npm run test:wix:policy

      - name: Etapa build MSI + Bundle
        shell: powershell
        run: powershell -NoProfile -ExecutionPolicy Bypass -File scripts/build-msi.ps1 -SkipStabilityChecks -IncludeBundle

      - name: Verificar artefactos
        shell: powershell
        run: |
          if (-not (Test-Path "dist/installer/EvaluaPro.msi")) { throw "No existe dist/installer/EvaluaPro.msi" }
          if (-not (Test-Path "dist/installer/EvaluaPro-Setup.exe")) { throw "No existe dist/installer/EvaluaPro-Setup.exe" }

      - name: Publicar artefactos instalador
        uses: actions/upload-artifact@v4
        with:
          name: installer-windows
          path: |
            dist/installer/EvaluaPro.msi
            dist/installer/EvaluaPro-Setup.exe
            dist/installer/*.wixpdb
