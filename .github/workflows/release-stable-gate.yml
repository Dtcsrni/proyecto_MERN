name: Release Stable Gate

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version estable a validar (ej. v1.0.0)"
        required: false
        type: string
      evidence_dir:
        description: "Ruta de evidencia (opcional)"
        required: false
        type: string

concurrency:
  group: release-stable-gate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  stable_gate:
    name: Stable Promotion Gate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'workflow_dispatch' ||
      (startsWith(github.ref, 'refs/tags/v') &&
      !contains(github.ref_name, '-alpha') &&
      !contains(github.ref_name, '-beta') &&
      !contains(github.ref_name, '-rc'))

    steps:
      - name: Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: |
            package-lock.json
            apps/backend/package-lock.json
            apps/frontend/package-lock.json
            apps/portal_alumno_cloud/package-lock.json

      - name: Instalar dependencias
        run: npm ci

      - name: Resolver version objetivo
        id: resolve_version
        shell: bash
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            TARGET="${{ inputs.version }}"
          else
            TARGET="${GITHUB_REF_NAME}"
          fi
          TARGET="${TARGET#v}"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

      - name: Ejecutar gate estable
        run: >
          node scripts/release/validate-stable-promotion.mjs
          --repo=${{ github.repository }}
          --version=${{ steps.resolve_version.outputs.target }}
          --required-streak=10
          --workflow=ci.yml
          --branch=main
          ${{ inputs.evidence_dir && format('--evidence-dir={0}', inputs.evidence_dir) || '' }}

      - name: Publicar decision de auditoria
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stable-gate-decision-${{ steps.resolve_version.outputs.target }}
          path: reports/release/stable-gate/${{ steps.resolve_version.outputs.target }}/decision.json
          if-no-files-found: warn

