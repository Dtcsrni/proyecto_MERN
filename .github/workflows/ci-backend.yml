name: CI Backend Module

on:
  workflow_dispatch:

concurrency:
  group: ci-backend-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend_module:
    name: Backend Module
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: |
            package-lock.json
            apps/backend/package-lock.json
            apps/frontend/package-lock.json
            apps/portal_alumno_cloud/package-lock.json

      - name: Instalar dependencias nativas de build (CV/imagen)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3 \
            make \
            g++ \
            cmake \
            pkg-config

      - name: Etapa setup
        run: npm ci

      - name: Preparar runtime CV nativo (linux-x64)
        run: npm install --no-save --include=optional --os=linux --cpu=x64 sharp

      - name: Etapa smoke OMR CV
        run: npm -C apps/backend run omr:cv:smoke

      - name: Etapa lint backend
        run: npm -C apps/backend run lint

      - name: Etapa typecheck backend
        run: npm -C apps/backend run typecheck

      - name: Etapa test backend
        run: npm run test:backend:ci

      - name: Etapa test portal alumno
        run: npm run test:portal:ci

      - name: Etapa build frontend alumno
        run: npm run build:frontend:alumno

      - name: Etapa tests OMR criticos
        run: npm -C apps/backend run test -- --reporter=verbose tests/omr.cv.engine.test.ts tests/omr.etapaScoring.fallback.test.ts tests/omr.prevalidacion.test.ts tests/omr.contrato.test.ts tests/integracion/qrEscaneoOmr.test.ts tests/omr.test.ts

      - name: Verificar dataset OMR TV3 real
        run: test -f omr_samples_tv3_real/manifest.json

      - name: Etapa benchmark OMR TV3 real gate
        run: npm -C apps/backend run omr:tv3:validate:real -- --dataset ../../omr_samples_tv3_real --report ../../reports/qa/latest/omr/tv3-real-validation.ci.json --failure-report ../../reports/qa/latest/omr/tv3-real-failure-analysis.ci.json

      - name: Publicar artefactos OMR QA
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: omr-qa-reports
          path: reports/qa/latest/omr/**
          if-no-files-found: warn

      - name: Etapa coverage backend
        run: npm -C apps/backend run test:coverage

      - name: Etapa tdd-debt-check
        run: npm run test:coverage:exclusions:debt

      - name: Preparar base para diff coverage (PR)
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Etapa diff-coverage-check
        run: npm run test:coverage:diff -- --apps backend

      - name: Etapa build backend
        run: npm -C apps/backend run build
